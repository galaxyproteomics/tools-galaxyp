<tool id="i2nca_pc_2_cc" name="i2nca Convert ProcessedCentroid" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@">

	<description>
        Convert centroid imzML files with i2nca and m2aia to obtain ContinuousCentroid files.

    </description>
	
    <macros>
    <import>macros.xml</import>
    </macros>
    
    <requirements>
    <!-- We'll skip the reqirements for now. Later we get a biocontainer, for now we'll do wonky conda env stuff-->
    </requirements>

    <command detect_errors="exit_code"><![CDATA[
    cp "${infile.extra_files_path}/imzml" indata.imzML &&
    cp "${infile.extra_files_path}/ibd" indata.ibd &&

    #if $choose_strategy.strategy == "fixed":

        #if $m2aia.use_m2aia_preproc == "FALSE":
            'i2nca_convert_to_cc' 'indata.imzML' './outdata' '$choose_strategy.strategy' '--acc' '$choose_strategy.value' &&

            mkdir $outfile_imzml.files_path &&

            mv ./outdata_conv_output_cont_centroid.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_centroid.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #else if $m2aia.use_m2aia_preproc == "TRUE": 
            'i2nca_convert_to_cc' 'indata.imzML' './outdata' '$choose_strategy.strategy' '--acc' '$choose_strategy.value'  @M2AIA_PARAMETERS@ &&

            mkdir $outfile_imzml.files_path &&

            mv ./outdata_conv_output_cont_centroid.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_centroid.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #end if
    #end if
    #if $choose_strategy.strategy == "unique":
        #if $m2aia.use_m2aia_preproc == "FALSE":
            'i2nca_convert_to_cc' 'indata.imzML' './outdata' '$choose_strategy.strategy' &&

            mkdir $outfile_imzml.files_path &&

            mv ./outdata_conv_output_cont_centroid.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_centroid.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #else if $m2aia.use_m2aia_preproc == "TRUE":

            'i2nca_convert_to_cc' 'indata.imzML' './outdata' '$choose_strategy.strategy' @M2AIA_PARAMETERS@ &&

            mkdir $outfile_imzml.files_path &&

            mv ./outdata_conv_output_cont_centroid.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_centroid.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml
        #end if
    #end if
    ]]></command>

    <inputs>
        <param name="infile" type="data" format="imzml" label="MSI data" help="Load the .imzml file on which the QC should be performed"/>

        <conditional name="choose_strategy">
            <param name="strategy" label="Choose how the centroids in the imzML file should be detected:" type="select" help="Different stategies can be used.">
                <option value="fixed" >Use a fixed axis</option>
                <option value="unique" >Use all unique m/z values</option>
            </param>

            <when value="fixed">
                <param name="value" label="Choose the accuracy of the shared axis in ppm:" type="integer"
                value="20"
                help="With this option, a mz axis will be calculated based on the ppm step size provided.
                      To this axis, all pixels will be binned."/>

            </when>

            <when value="unique">

            </when>
        </conditional>

        <expand macro="m2aia_preprocessing"/>

    </inputs>

    <outputs>
        <data format="imzml" name="outfile_imzml" label="ContinuousCentroid imzML, Conversion result of ${on_string}: imzML"/>
    </outputs>

    <tests>
        <!-- Test 1: Conversion using unique -->
        <test>
            <expand macro="pc_infile"/>
            <conditional name="choose_strategy">
                <param name="strategy" value="unique" />
            </conditional>
            <conditional name="m2aia">
                <param name="use_m2aia_preproc" value="FALSE" />
            </conditional>
            <output name="outfile_imzml" ftype="imzml">
                <extra_files type="file" file="pc_test1.imzml" name="imzml" lines_diff="6"/>
                <extra_files type="file" file="pc_test1.ibd" name="ibd" compare="sim_size"/>
            </output>
        </test>

        <!-- Test 2: Conversion using fixed binning-->
        <test>
            <expand macro="pc_infile"/>
            <conditional name="choose_strategy">
                <param name="strategy" value="fixed" />
                <param name="value" value="25" />
            </conditional>
            <conditional name="m2aia">
                <param name="use_m2aia_preproc" value="FALSE" />
            </conditional>
            <output name="outfile_imzml" ftype="imzml">
                <extra_files type="file" file="pc_test2.imzml" name="imzml" lines_diff="6"/>
                <extra_files type="file" file="pc_test2.ibd" name="ibd" compare="sim_size"/>
            </output>
        </test>
    
        <!-- Test 3: Conversion using unique with m2aia preprocessing -->
        <test>
            <expand macro="pc_infile"/>
            <conditional name="choose_strategy">
                <param name="strategy" value="unique" />
            </conditional>
            <conditional name="m2aia">
                <param name="use_m2aia_preproc" value="TRUE" />
                <param name="nor" value="RMS" />
                <param name="itr" value="Log2" />
                <param name="bsl_hws" value="45" />
                <param name="bsl" value="TopHat" />
                <param name="smo_hws" value="23" />
                <param name="smo" value="Gaussian" />
            </conditional>
            <output name="outfile_imzml" ftype="imzml">
                <extra_files type="file" file="pc_test3.imzml" name="imzml" lines_diff="6"/>
                <extra_files type="file" file="pc_test3.ibd" name="ibd" compare="sim_size"/>
            </output>
        </test> -->
    
        <!-- Test 4: Conversion using fixed binning with m2aia preprocessing -->
        <test>
            <expand macro="pc_infile"/>
            <conditional name="choose_strategy">
                <param name="strategy" value="fixed" />
                <param name="value" value="25" />
            </conditional>
            <conditional name="m2aia">
                <param name="use_m2aia_preproc" value="TRUE" />
                <param name="nor" value="TIC" />
                <param name="itr" value="SquareRoot" />
                <param name="bsl_hws" value="32" />
                <param name="bsl" value="Median" />
                <param name="smo_hws" value="64" />
                <param name="smo" value="SavitzkyGolay" />
            </conditional>
            <output name="outfile_imzml" ftype="imzml">
                <extra_files type="file" file="pc_test4.imzml" name="imzml" lines_diff="6"/>
                <extra_files type="file" file="pc_test4.ibd" name="ibd" compare="sim_size"/>
            </output>
        </test>

        <!-- Test 5: Conversion using fixed binning with cc input -->
        <test>
            <expand macro="pc_infile"/>
            <conditional name="choose_strategy">
                <param name="strategy" value="fixed" />
                <param name="value" value="100" />
            </conditional>
            <conditional name="m2aia">
                <param name="use_m2aia_preproc" value="FALSE" />
            </conditional>
            <output name="outfile_imzml" ftype="imzml">
                <extra_files type="file" file="pc_test5.imzml" name="imzml" lines_diff="6"/>
                <extra_files type="file" file="pc_test5.ibd" name="ibd" compare="sim_size"/>
            </output>
        </test>
    </tests>

    <help><![CDATA[
        @I2NCA_DESCRIPTION@
    
        This tool performs the internal conversion from a ProcessedCentroid imzml file to a ContinuousCentroid imzml file.
        
    
        **Input data**
        
    
        @MSIDATA_INPUT_DESCRIPTION@
        
    
        **Conversion strategy**
        
    
        The conversion is achieved by using different preprocessing methods.
            - Fixed axis: For this stragegy, the mz values of each pixel are sorted to a fixed reference m/z axis. The axis generation is controlled by a step-length provided in ppm. This is a binning operation.
            - Unique values: All m/z values that occur in the dataset are collected and used as reference axis. THis produces a large number of zeroes to be introduced and is only recommended for small datasets.
        @M2AIA_INPUT_DESCRIPTION@
        ]]></help>
        <citations>
            <citation type="bibtex">
                @misc{githubi2nca,
                author = {Jannik Witte},
                title = {i2nca},
                publisher = {GitHub},
                journal = {Github repository},
                url = {https://github.com/cKNUSPeR/i2nca}
            }
            </citation>
            <citation type="bibtex">
                @article{10.1093/gigascience/giab049,
                    author = {Cordes, Jonas and Enzlein, Thomas and Marsching, Christian and Hinze, Marven and Engelhardt, Sandy and Hopf, Carsten and Wolf, Ivo},
                    title = "{M2aiaâ€”Interactive, fast, and memory-efficient analysis of 2D and 3D multi-modal mass spectrometry imaging data}",
                    journal = {GigaScience},
                    volume = {10},
                    number = {7},
                    year = {2021},
                    month = {07},
                    issn = {2047-217X},
                    doi = {10.1093/gigascience/giab049},
                    url = {https://doi.org/10.1093/gigascience/giab049}
                }
            </citation>
        </citations>
</tool>
