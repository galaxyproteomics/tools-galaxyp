<tool id="i2nca_pp_2_cp" name="i2nca Convert ProcessedProfile" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@">

	<description>
        Convert ProcessedProfile imzML files with i2nca and m2aia to obtain ContinuousProfile imzML files.

    </description>
	
    <macros>
    <import>macros.xml</import>
    </macros>
    
    <requirements>
        <container type="docker">biocontainers/i2nca:0.3.12_cv1</container>
    </requirements>


    <command detect_errors="exit_code"><![CDATA[
    cp "${infile.extra_files_path}/imzml" indata.imzML &&
    cp "${infile.extra_files_path}/ibd" indata.ibd &&
    #if $choose_strategy.strategy == "fixed_alignment":
        #if $m2aia.use_m2aia_preproc == "FALSE":
            'i2nca_convert_to_cp' '--cov' '${choose_strategy.value}' 'indata.imzML' './outdata' '$choose_strategy.strategy' &&

            mkdir $outfile_imzml.files_path &&
            mv ./outdata_conv_output_cont_profile.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_profile.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #else if $m2aia.use_m2aia_preproc == "TRUE":
            'i2nca_convert_to_cp' '--cov' '${choose_strategy.value}' 'indata.imzML' './outdata' '$choose_strategy.strategy' @M2AIA_PARAMETERS@ &&

            mkdir $outfile_imzml.files_path &&
            mv ./outdata_conv_output_cont_profile.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_profile.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #end if
    #end if
    #if $choose_strategy.strategy == "fixed_binning":
        #if $m2aia.use_m2aia_preproc == "FALSE":
            'i2nca_convert_to_cp' '--acc' '${choose_strategy.value}' 'indata.imzML' './outdata' '$choose_strategy.strategy' &&

            mkdir $outfile_imzml.files_path &&
            mv ./outdata_conv_output_cont_profile.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_profile.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #else if $m2aia.use_m2aia_preproc == "TRUE":
            'i2nca_convert_to_cp' '--acc' '${choose_strategy.value}' 'indata.imzML' './outdata' '$choose_strategy.strategy' @M2AIA_PARAMETERS@ &&
            mkdir $outfile_imzml.files_path &&
            mv ./outdata_conv_output_cont_profile.imzML "${os.path.join($outfile_imzml.files_path, 'imzml')}" | true &&
            mv ./outdata_conv_output_cont_profile.ibd "${os.path.join($outfile_imzml.files_path, 'ibd')}" | true &&

            echo "imzML file:" > $outfile_imzml &&
            ls -l "$outfile_imzml.files_path" >> $outfile_imzml

        #end if
    #end if
    ]]></command>

    <inputs>
        <param name="infile" type="data" format="imzml" label="MSI data" help="Load the imzml file (as imzml Composite)"/>

        <conditional name="choose_strategy">
            <param name="strategy" label="Choose how the continous profile imzML file should be created:" type="select" help="Different stategies can be used.">
                <option value="fixed_alignment" >Alignment</option>
                <option value="fixed_binning" >Binning</option>
            </param>
            <when value="fixed_alignment">

                <param name="value" label="Choose a subsample range for average mz axis calculation:" type="float"
                       value="0.05" min="0.00" max="1.00"
                       help="With this option, a mz axis will be calculated from the given percentage of the files pixels.
                             To this averaged axis, all pixels will be aligned. Problems can arise if pixels do not share the same number of data points. Tipp:
                             Use the MSI QC tools to check if this is the case."/>
            </when>
            <when value="fixed_binning">

                <param name="value" label="Choose the binning accuracy in ppm:" type="integer"
                       value="20"
                       help="With this option, a mz axis will be calculated based on the ppm step size provided.
                             To this axis, all pixels will be binned."/>

            </when>
        </conditional>


       <expand macro="m2aia_preprocessing"/>

    </inputs>

    <outputs>
        <data format="imzml" name="outfile_imzml" label="ContinuousProfile imzML, Conversion result of ${on_string}: imzML"/>
    </outputs>

    <tests>
        <!-- Test 1: Conversion using fixed alignment -->
        <test>
            <expand macro="pp_infile"/>
            <conditional name="choose_strategy">
                <param name="strategy" value="fixed_alignment" />
                <param name="value" value="0.5" />
            </conditional>
            <conditional name="m2aia">
                <param name="use_m2aia_preproc" value="FALSE" />
            </conditional>
            <output name="outfile_imzml" ftype="imzml">
                <extra_files type="file" file="pp_test1.imzml" name="imzml" lines_diff="6"/>
                <extra_files type="file" file="pp_test1.ibd" name="ibd" compare="sim_size"/>
            </output>
        </test>

        <!-- Test 2: Conversion using fixed binning -->
        <test>
            <expand macro="pp_infile"/>
            <conditional name="choose_strategy">
                <param name="strategy" value="fixed_binning" />
                <param name="value" value="50" />
            </conditional>
            <conditional name="m2aia">
                <param name="use_m2aia_preproc" value="FALSE" />
            </conditional>
            <output name="outfile_imzml" ftype="imzml">
                <extra_files type="file" file="pp_test2.imzml" name="imzml" lines_diff="6"/>
                <extra_files type="file" file="pp_test2.ibd" name="ibd" compare="sim_size"/>
            </output>
        </test>
    
        <!-- Test 3: Conversion using fixed alignment with m2aia preprocessing -->
        <test>
            <expand macro="pp_infile"/>
            <conditional name="choose_strategy">
                <param name="strategy" value="fixed_alignment" />
                <param name="value" value="0.5" />
            </conditional>
            <conditional name="m2aia">
                <param name="use_m2aia_preproc" value="TRUE" />
                <param name="nor" value="TIC" />
                <param name="itr" value="Log2" />
                <param name="bsl_hws" value="15" />
                <param name="bsl" value="Median" />
                <param name="smo_hws" value="5" />
                <param name="smo" value="SavitzkyGolay" />
            </conditional>
            <output name="outfile_imzml" ftype="imzml">
                <extra_files type="file" file="pp_test3.imzml" name="imzml" lines_diff="6"/>
                <extra_files type="file" file="pp_test3.ibd" name="ibd" compare="sim_size"/>
            </output>
        </test>
    
        <!-- Test 4: Conversion using fixed binning with m2aia preprocessing -->
        <test>
            <expand macro="pp_infile"/>
            <conditional name="choose_strategy">
                <param name="strategy" value="fixed_binning" />
                <param name="value" value="50" />
            </conditional>
            <conditional name="m2aia">
                <param name="use_m2aia_preproc" value="TRUE" />
                <param name="nor" value="TIC" />
                <param name="itr" value="Log2" />
                <param name="bsl_hws" value="15" />
                <param name="bsl" value="Median" />
                <param name="smo_hws" value="5" />
                <param name="smo" value="SavitzkyGolay" />
            </conditional>
            <output name="outfile_imzml" ftype="imzml">
                <extra_files type="file" file="pp_test4.imzml" name="imzml" lines_diff="6"/>
                <extra_files type="file" file="pp_test4.ibd" name="ibd" compare="sim_size"/>
            </output>
        </test>

    </tests>
    <help><![CDATA[
    @I2NCA_DESCRIPTION@

    This tool performs the internal conversion from a ProcessedProfile imzml file to a ContinuousProfile imzml file.
    

    **Input data**
    

    @MSIDATA_INPUT_DESCRIPTION@
    

    **Conversion strategy**
    

    The conversion is achieved by using different preprocessing methods.
        - Binning: For binning, he mz values of each pixel are sorted to a fixed reference m/z axis. The axis generation is controlled by a step-length provided in ppm.
        - Alignment: The alignment assumes that all spectra are of the same length and calculates a mean m/z axis, to which the intensities of all pixels get written.
    
    @M2AIA_INPUT_DESCRIPTION@
    ]]></help>
    <citations>
        <citation type="bibtex">
            @misc{githubi2nca,
            author = {Jannik Witte},
            title = {i2nca},
            publisher = {GitHub},
            journal = {Github repository},
            url = {https://github.com/cKNUSPeR/i2nca}
        }
        </citation>
        <citation type="bibtex">
            @article{10.1093/gigascience/giab049,
                author = {Cordes, Jonas and Enzlein, Thomas and Marsching, Christian and Hinze, Marven and Engelhardt, Sandy and Hopf, Carsten and Wolf, Ivo},
                title = "{M2aiaâ€”Interactive, fast, and memory-efficient analysis of 2D and 3D multi-modal mass spectrometry imaging data}",
                journal = {GigaScience},
                volume = {10},
                number = {7},
                year = {2021},
                month = {07},
                issn = {2047-217X},
                doi = {10.1093/gigascience/giab049},
                url = {https://doi.org/10.1093/gigascience/giab049}
            }
        </citation>
    </citations>
</tool>
