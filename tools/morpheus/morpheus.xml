<tool id="morpheus" name="Morpheus" version="1.171.1">
    <description>database search algorithm for high-resolution tandem mass spectra</description>
    <macros>
        <xml name="modification_options">
            <option value="carbamidomethylation of C">carbamidomethylation of C</option>
            <option value="oxidation of M">oxidation of M</option>
            <option value="acetylation of protein N-terminus">acetylation of protein N-terminus</option>
            <option value="acetylation of lysine">acetylation of lysine</option>
            <option value="phosphorylation of S">phosphorylation of S</option>
            <option value="phosphorylation of T">phosphorylation of T</option>
            <option value="phosphorylation of Y">phosphorylation of Y</option>
            <option value="deamidation of N">deamidation of N</option>
            <option value="deamidation of Q">deamidation of Q</option>
            <option value="pyro-cmC">pyro-cmC</option>
            <option value="pyro-E">pyro-E</option>
            <option value="pyro-Q">pyro-Q</option>
            <option value="TMT zero on peptide N-terminus">TMT zero on peptide N-terminus</option>
            <option value="TMT zero on K">TMT zero on K</option>
            <option value="TMT zero on Y">TMT zero on Y</option>
            <option value="TMT duplex on peptide N-terminus">TMT duplex on peptide N-terminus</option>
            <option value="TMT duplex on K">TMT duplex on K</option>
            <option value="TMT duplex on Y">TMT duplex on Y</option>
            <option value="TMT sixplex/tenplex on peptide N-terminus">TMT sixplex/tenplex on peptide N-terminus</option>
            <option value="TMT sixplex/tenplex on K">TMT sixplex/tenplex on K</option>
            <option value="TMT sixplex/tenplex on Y">TMT sixplex/tenplex on Y</option>
            <option value="iTRAQ 4-plex on peptide N-terminus">iTRAQ 4-plex on peptide N-terminus</option>
            <option value="iTRAQ 4-plex on K">iTRAQ 4-plex on K</option>
            <option value="iTRAQ 4-plex on Y">iTRAQ 4-plex on Y</option>
            <option value="iTRAQ 8-plex on peptide N-terminus">iTRAQ 8-plex on peptide N-terminus</option>
            <option value="iTRAQ 8-plex on K">iTRAQ 8-plex on K</option>
            <option value="iTRAQ 8-plex on Y    ">iTRAQ 8-plex on Y    </option>
        </xml>
    </macros>

    <requirements>
        <requirement version="4.0">mono</requirement>
        <requirement version="171">morpheus</requirement>
    </requirements>

    <stdio>
        <exit_code range="1:" />
        <regex match="System..*Exception"
           source="both"
           level="fatal"
           description="Error encountered" />
    </stdio>

    <command><![CDATA[
        ln -s $input input.mzml
        && mono \${MORPHEUS_PATH}/morpheus_cl.exe 
        -d="input.mzml"
        -db="$searchdb"
        #if isinstance($searchdb.datatype, $__app__.datatypes_registry.get_datatype_by_extension('uniprotxml').__class__): 
          #if str( $advanced.adv_options_selector) == "set":
            $advance.noup
          #end if
        #end if
        ## fm vm fdr mvmi precmt precmtv precmtu
        #if  str($fdr):
            -fdr=$fdr
        #end if
        #if  str($mvmi):
            -mvmi=$mvmi
        #end if
        #if  str($precmt):
            -precmt=$precmt
        #end if
        #if  str($precmtv):
            -precmtv=$precmtv
        #end if
        #if  str($precmtu):
            -precmtu=$precmtu
        #end if
        #if str( $advanced.adv_options_selector) == "set":
            #if  str($advanced.minprecz):
                -minprecz=$advanced.minprecz
            #end if
            #if  str($advanced.maxprecz):
                -maxprecz=$advanced.maxprecz
            #end if
            #if  str($advanced.at):
                -at=$advanced.at
            #end if
            #if  str($advanced.rt):
                -rt=$advanced.rt
            #end if
            #if  str($advanced.mp):
                -mp=$advanced.mp
            #end if
            #if  str($advanced.mmc):
                -mmc=$advanced.mmc
            #end if
            #if  str($advanced.prodmt):
                -prodmt=$advanced.prodmt
            #end if
            #if  str($advanced.prodmtu):
                -prodmtu=$advanced.prodmtu
            #end if
            #if  str($advanced.minpmo):
                -minpmo=$advanced.minpmo
            #end if
            #if  str($advanced.maxpmo):
                -maxpmo=$advanced.maxpmo
            #end if
            #if  str($advanced.prodmtv):
                -prodmtv=$advanced.prodmtv
            #end if
            #if  str($advanced.imb):
                -imb=$advanced.imb
            #end if
            $advanced.acs $advanced.di $advanced.ad $advanced.pmc $advanced.cmu $advanced.mmu
        #end if
        #if str($fm) != 'None':
            #set $fmods = str($fm).replace(',',';')
            -fm="$fmods"
        #end if
        #if str($vm) != 'None':
            #set $vmods = str($vm).replace(',',';')
            -vm="$vmods"
        #end if
        -mt=\${GALAXY_SLOTS:-4}
        
    ]]></command>
    <inputs>
        <param name="input" type="data" format="indexedmzML" label='Indexed mzML' />
        <param name="searchdb" type="data" format="fasta,uniprotxml" label="MS Protein Search Database: UniProt Xml or Fasta"/>
        <param name="fm" type="select" multiple="true" optional="true" label="Fixed Modifications">
            <expand macro="modification_options" />
        </param>
        <param name="vm" type="select" multiple="true" optional="true" label="Variable Modifications">
            <expand macro="modification_options" />
        </param>
        <param name="fdr" type="float" value="1" optional="true" min="0.0" max="100.0" label="FDR (Maximum False Discovery Rate percent)" />
        <param name="mvmi" type="integer" value="1024" optional="true" min="0" label="Maximum Variable Modification Isoforms Per Peptide" />
        <param name="precmt" type="select" optional="true" label="Precursor Mass Type">
            <option value="Monoisotopic">Monoisotopic</option>
            <option value="Average">Average</option>
        </param>
        <param name="precmtv" type="float" value="10." optional="true" label="Precursor Mass Tolerance Value" />
        <param name="precmtu" type="select" optional="true" label="Precursor Mass Tolerance Units">
            <option value="ppm" selected="true">ppm</option>
            <option value="Da">Daltons</option>
        </param>
        <conditional name="advanced">
            <param name="adv_options_selector" type="select" label="Set advanced options?" help="Provides additional controls">
                <option value="set">Set</option>
                <option value="do_not_set" selected="True">Do not set</option>
            </param>
            <when value="set">
                <param name="noup" type="boolean" truevalue="" falsevalue="-noup=true" checked="True" label="Use G-PTM with Uniprot Proteome Search Databases" />
                <param name="minprecz" type="integer" value="2" optional="true" label="Minimum Unknown Precursor Charge State" />
                <param name="maxprecz" type="integer" value="4" optional="true" label="Maximum Unknown Precursor Charge State" />
                <param name="at" type="float" value="" optional="true" min="0.0" label="Absolute MS/MS Intensity Threshold" />
                <param name="rt" type="float" value="" optional="true" min="0.0" label="Relative MS/MS Intensity Threshold" />
                <param name="mp" type="integer" value="" optional="true" min="-1" label="Maximum Number of MS/MS Peaks" help="to disable set to: -1"/>
                <param name="acs" type="boolean" truevalue="-acs=true" falsevalue="-acs=false" checked="true" optional="true" label="Assign Charge States" />
                <param name="di" type="boolean" truevalue="-di=true" falsevalue="-di=false" checked="true" optional="true" label="Deisotope" />
                <param name="ad" type="boolean" truevalue="-ad=true" falsevalue="-ad=false" checked="false" optional="true" label="Append Decoys" />
                <param name="mmc" type="integer" value="2" optional="true" min="0" max="20" label="Maximum Missed Cleavages" />
                <param name="pmc" type="boolean" truevalue="-pmc=true" falsevalue="-pmc=false" checked="false" optional="true" label="Precursor Monoisotopic Peak Correction" />
                <param name="minpmo" type="integer" value="" optional="true" label="Minimum Precursor Monoisotopic Peak Correction" />
                <param name="maxpmo" type="integer" value="" optional="true" label="Maximum Precursor Monoisotopic Peak Correction" />
                <param name="prodmtv" type="float" value="" optional="true" label="Product Mass Tolerance Value" />
                <param name="prodmt" type="select" optional="true" label="Product Mass Type">
                    <option value="Monoisotopic">Monoisotopic</option>
                    <option value="Average">Average</option>
                </param>
                <param name="prodmtu" type="select" optional="true" label="Product Mass Tolerance Units">
                    <option value="Da">Daltons</option>
                    <option value="ppm">ppm</option>
                </param>
                <param name="imb" type="select" optional="true" label="Initiator Methionine Behavior">
                    <option value="Variable">Variable</option>
                    <option value="Retain">Retain</option>
                    <option value="Cleave">Cleave</option>
                </param>
                <param name="cmu" type="boolean" truevalue="-cmu=true" falsevalue="-cmu=false" checked="false" optional="true" label="Consider Modifications Unique" />
                <param name="mmu" type="boolean" truevalue="-mmu=true" falsevalue="-mmu=false" checked="false" optional="true" label="Minimize Memory Usage" />
            </when>
            <when value="do_not_set"/>
        </conditional>
    </inputs>
    <outputs>
        <data name="summary" format="txt" label="${input.name.rsplit('.',1)[0]} summary.txt" from_work_dir="summary.txt" />
        <data name="log" format="txt" label="${input.name.rsplit('.',1)[0]}.log.txt" from_work_dir="input.log.txt" />
        <data name="output_psms" format="tabular" label="${input.name.rsplit('.',1)[0]}.PSMs.tsv" from_work_dir="input.PSMs.tsv" />
        <data name="output_unique_peptides" format="tabular" label="${input.name.rsplit('.',1)[0]}.unique_peptides.tsv" from_work_dir="input.unique_peptides.tsv" />
        <data name="output_protein_groups" format="tabular" label="${input.name.rsplit('.',1)[0]}.protein_groups.tsv" from_work_dir="input.protein_groups.tsv" />
        <data name="output_pepxml" format="pepxml" label="${input.name.rsplit('.',1)[0]}.pep.xml" from_work_dir="input.pep.xml" />
    </outputs>
    <help><![CDATA[
        TODO: Fill in help.
    ]]></help>
    <citations>
        <citation type="doi">10.1021/pr301024c</citation>
    </citations>
</tool>
