<tool id="msslookup_quant" name="Create lookup table with quant data" version="1.1">
    <description>of openMS isobaric quant and Kronik MS1 quant</description>
    <requirements>
        <requirement type="package" version="2.5">msstitch</requirement>
    </requirements>  
    <command detect_errors="exit_code">
        <![CDATA[
        cp '$dbfile' spec_lookup.sql

        #if "true" in [$precursor.yesno, $consxml.yesno]
            #for $displayname in $spectra.keys()
                && ln -s '$spectra[$displayname]' '$displayname'
            #end for
        #end if

        #if $precursor.yesno == "true"
            &&
            msslookup ms1quant --dbfile spec_lookup.sql -i
            #for $fn in $precursor.quantdata.keys()
                '$precursor.quantdata[$fn]'
            #end for
            --spectra 
            #for $displayname in $spectra.keys()
                '$displayname'
            #end for
            --quanttype $precursor.quanttype --mztol $precursor.mztol --mztoltype $precursor.mztoltype --rttol $precursor.rttol
        #end if

        #if $consxml.yesno == "true"
            &&
            msslookup isoquant --dbfile spec_lookup.sql -i
            #for $fn in $consxml.quantdata.keys()
                '$consxml.quantdata[$fn]'
            #end for
            --spectra 
            #for $displayname in $spectra.keys()
                '$displayname'
            #end for
        #end if 

        &&
        mv spec_lookup.sql '$output'
        ]]>
    </command>
    <inputs>
        <param name="spectra" type="data_collection" collection_type="list" format="mzml" label="Spectra in mzML" />
        <param name="dbfile" type="data" format="sqlite" label="Existing lookup table containing spectra" />
        <conditional name="consxml">
            <param type="select" label="Store isobaric quant data?" display="radio" name="yesno">
                <option value="true">Yes</option>
                <option value="false">No</option>
           </param>
           <when value="true">
               <param name="quantdata" type="data_collection" format="consensusxml" label="Quant data in consensusXML" /> 
           </when> 
           <when value="false" />
        </conditional>
        <conditional name="precursor">
            <param type="select" display="radio" label="Store MS1 quant data?" name="yesno">
                <option value="true">Yes</option>
                <option value="false">No</option>
           </param>
            <when value="true">
                <param name="quanttype" type="select" label="Quantification output type">
                    <option value="kronik" selected="true">Kronik</option>
                </param>
                 <param name="quantdata" type="data_collection" format="kronik" label="Quant data from kronik" />
                 <param name="rttol" type="float" label="Retention time lookup tolerance value in seconds" value="5" />
                 <param name="mztol" type="float" label="m/z lookup tolerance value" value="20" />
                 <param name="mztoltype" type="select" label="m/z lookup tolerance unit">
                     <option value="ppm">ppm</option>
                     <option value="Da">Da</option>
                </param>
            </when>
            <when value="false" />
        </conditional>
    </inputs>
    <outputs>
        <data format="sqlite" name="output"/>
    </outputs>
    <tests>
        <test>
            <param name="spectra">
                <collection type="list">
                    <element name="set1_spectra.mzml" value="spectra.mzml" />
                    <element name="set2_spectra.mzml" value="spectra.mzml" />
                </collection>
            </param>
            <param name="dbfile" value="spectra.sql" />
            <param name="consxml|yesno" value="true" />
            <param name="consxml|quantdata">
                <collection type="list"> 
                    <element name="set1_quant.consensusxml" value="quant.consensusxml" />
                    <element name="set2_quant.consensusxml" value="quant.consensusxml" />
                </collection>
            </param>
            <param name="precursor|yesno" value="true" />
            <param name="precursor|quanttype" value="kronik" />
            <param name="precursor|quantdata">
                <collection type="list"> 
                    <element name="set1_quant.kr" value="quant.kr" />
                    <element name="set2_quant.kr" value="quant.kr" />
                </collection>
            </param>
            <param name="precursor|rttol" value="6" />
            <param name="precursor|mztol" value="20" />
            <param name="precursor|mztoltype" value="ppm" />
            <output name="output" md5="d1d01d561f12597ab4c8fadf858f37df" />
        </test>
    </tests>
    <help>
        This stores quantification data from OpenMS Isobaric Analyzer (see citations) tools in an SQLite lookup database
        for later use in PSM quantification.
    </help>
    <citations>
        <citation type="doi">10.1038/nmeth.3959</citation>
    </citations>
</tool>
