<tool id="msspercolator_split" name="Split percolator output" version="1.0">
    <description>on target/decoy or protein header</description>
    <requirements>
        <requirement type="package" version="2.2">msstitch</requirement>
    </requirements>
    <command>
            <![CDATA[
	    ln -s '$input' perco.xml && 
	   
	    #if $splitter.splittype.value == "td"
	    msspercolator splittd -i perco.xml 
	    && mv perco.xml_target.xml $targetout
	    && mv perco.xml_decoy.xml $decoyout

	    
	    #else if $splitter.splittype.value == "header"
            mkdir splitfiles &&
	    splitprotein -i $input -d splitfiles
	    --protheaders
	    #for $header in $splitter.headers
	    '$header.pattern'
	    #end for
	    #for $ix, $header in $enumerate($splitter.headers)
	    #set outfile = "perco.xml_h{}.xml".format($ix)
	    #set newfile = "header_{}_{}.xml".format($ix, $header.pattern)
            &&
	    mv $outfile $newfile
	    #end for
#end if
            ]]>
            </command>
    <inputs>

    <param name="input" type="data" format="percout" label="Percolator output data" />
    <conditional name="splitter">
	    <param name="splittype" type="select" label="Split data into">
		    <option value="td">target/decoy data</option>
		    <option value="header">different protein headers</option>
	    </param>
	    <when value="td" />
	    <when value="header">
                    <repeat name="headers" title="Protein class headers" help="Each specified header regex will lead to its own dataset. Non-matching headers will be filtered out. Multiple headers for one dataset can be separated in the same regex with a semicolon." >
                        <param name="pattern" type="text" label="Header pattern regex" help="E.g. ^ENSP" />
                    </repeat>
	    </when>
    </conditional>
    
    </inputs>
    
    <outputs>
	    <data name="headerout" format="mzid">
               <filter>splitter['splittype'] == 'header'</filter>
               <discover_datasets pattern="__designation__" ext="percout" directory="splitfiles" />
            </data>
	    <data format="percout" name="targetout"> 
		    <filter>splitter['splittype'] == 'td'</filter>
	    </data>
	   <data format="percout" name="decoyout">
		    <filter>splitter['splittype'] == 'td'</filter>
	    </data>
    </outputs>
    
  <help>
      Split percolator output into multiple files. Use target/decoy to split into a target and a decoy file, or protein header to
      define a number of protein header regexes to split into that number of percolator files containing PSMs and peptides
      matching to those headers.
  </help>
</tool>
