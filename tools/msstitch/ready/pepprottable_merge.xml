<tool id="msspepprottable_merge" name="Merge peptide or protein tables">
    <requirements>
        <requirement type="package" version="2.2">msstitch</requirement>
    </requirements>
    <description>containing multiple biological sets</description>
    <command>
	    cp '$lookup' psmpg_lookup.sql
	    &&
	    mslookup
	    
	    #if quants.type == "protein"
	    proteins --protcol '$featcol'
	    #if $quants.probpattern
            --probcolpattern '$quants.probpattern'
	    #end if
            #if str($genecentric) != "None"
            --genecentric $quants.genecentric
            #end if
  
	    #elif quants.type == "peptide"
	    peptides --peptidecol '$featcol' 
	    #end if
	    
	    --dbfile psmpg_lookup.sql -i
            #for $fn in $tables.keys()
            '$tables[$fn]'
            #end for
            --filekeys
            #for $spfn in $tables.keys()
            '$spfn'
            #end for
            #if $precurqcolpattern
            --ms1quantcolpattern '$precurqcolpattern'
            #end if
            #if $nopsmcolpattern
            --psmnrcolpattern '$nopsmcolpattern' 
            #end if
            #if $isobqcolpattern
            --isobquantcolpattern '$isobqcolpattern'
            #end if
            #if $fdrpattern
            --fdrcolpattern '$fdrpattern'
            #end if
            #if $peppattern
            --pepcolpattern '$peppattern'
            #end if
	    &&
	    #if quants.type == "protein"
	    prottable build
            #if str($quants.genecentric) != "None"
            --genecentric $quants.genecentric
            #end if
            #if $fdrcutoff.value
            --mergecutoff $quants.fdrcutoff
            #end if
            #if $probability
            --probability
            #end if

	    #elif quants.type == "peptide"
	    peptable build 
            #if $quants.centric.value == "gene"
            --genecentric
            #else if $centric.value == "plain"
            --noncentric
            #end if
	    #end if
	    
	    --dbfile psmpg_lookup.sql -o '$mergedout'
            #if $isobqcolpattern
            --isobaric
            #end if
            #if $precurqcolpattern
            --precursor
            #end if
            #if $fdrpattern
            --fdr
            #end if
            #if $peppattern
            --pep
            #end if
	    &&
	    mv psmpg_lookup.sql '$lookupoutput'
	    
    </command>
    
    <inputs>
      <param name="lookup" type="data" format="mslookupsql" label="Lookup file containing PSM/spectra info" />
      <param name="tables" type="data_collection" format="tabular" label="Data to merge"  />
      <param name="featcol" type="integer" value="1" min="1" label="Column number in which accessions/sequences are" />
      <conditional name="quants">
	      <param name="type" type="select" label="Data type to merge" display="radio">
		      <option value="peptide">Peptides</option>
		      <option value="protein">Proteins</option>
	      </param>
	      <when value="peptide">
		      <param name="centric" type="select" display="radio" label="Center data on">
			  <option value="pg" selected="true">protein groups</option>
			  <option value="gene">genes</option>
			  <option value="plain">non-centric</option>
		      </param>
	      </when>
	      <when value="protein">
		      <param name="genecentric" type="select" label="Genecentric analysis?">
		        <option value="None">No</option>
		        <option value="genes">Gene-centric (genes as in FASTA file)</option>
		        <option value="assoc">Associated IDs (genes as in Biomart external IDs)</option>
		      </param>
		      <param name="probpattern" type="text" label="Regular expression pattern to identify columns containing the probability of a protein in the table" optional="true" help="E.g. probability" />
		      <param name="fdrcutoff" type="float" label="FDR cutoff for inclusion" optional="true" />
	      </when>
      </conditional>
      <param name="precurqcolpattern" type="text" label="Regular expression pattern to identify precursor quant columns" optional="true" help="E.g. area"/>
      <param name="isobqcolpattern" type="text" label="Regular expression pattern to identify columns containing isobaric quantification data" optional="true" help="E.g. tmt10plex, plex" />
      <param name="nopsmcolpattern" type="text" label="Regular expression pattern to identify columns containing the amount of PSMs quantified" optional="true" help="E.g. quanted" />
      <param name="fdrpattern" type="text" label="Regular expression pattern to identify columns containing protein FDR" optional="true" help="E.g. q-value" />
      <param name="peppattern" type="text" label="Regular expression pattern to identify columns containing protein PEP" optional="true" help="E.g. PEP" />
      </inputs>
    <outputs>
        <data format="tabular" name="mergedout"/>
        <data format="mslookupsql" name="lookupoutput"/>
    </outputs>

    <help>
    </help>

</tool>
