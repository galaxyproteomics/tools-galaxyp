<tool id="msspercolator_filter" name="Filter percolator output">
    <requirements>
        <requirement type="package" version="2.2">msstitch</requirement>
    </requirements>
    <description>retain uniques or specific protein headers</description>
    <!-- FIXME Tool to be made-->
    <command>
	    ln -s '$input' perco.xml
	    #if $filterprot.yesno == "yes"
	    msspercolator splitprotein -i perco.xml -o protfiltered.xml
	    --protheaders
            "#slurp
#for $header in $filterprot.headers
$header.pattern;#slurp
#end for
"
            && mv filtered.xml perco.xml
	    #end if

	    #if $filterlen.yesno == "yes"
	    msspercolator filterlen -i perco.xml -o filtered.xml
	    --maxlen $filterlen.maxlen --minlen $filterlen.minlen 
            && mv filtered.xml perco.xml
            #end if

	    #if $filteruni.yesno == "yes"
	    msspercolator filteruni -i perco.xml -o filtered.xml
	    --score $filteruni.score
            && mv filtered.xml perco.xml
	    #end if

	    #if $filterprot.yesno == "yes"
	    cp '$filterprot.lookup' seqdb.sqlite
	    &&
	    msspercolator filterprot -i perco.xml -o filtered.xml
            --fasta '$filterprot.fasta' --dbfile seqdb.sqlite --minlen $filterprot.minlength
	    #if $filterprot.deamidate
	    --deamidate
	    #end if
	    #if $filterprot.forcetryp
	    --enforce-tryptic
	    #end if
            && mv filtered.xml perco.xml
	    #end if
	    
	    #if $filterseq.yesno == "yes"
            cp '$filterseq.lookup' seqdb.sqlite
	    &&
	    msspercolator filterseq -i perco.xml -o filtered.xml --dbfile seqdb.sqlite
	    #if $filterseq.falloff.value > 0
	    --insourcefrag $filterseq.falloff
	    #end if
	    #if $filterseq.deamidate
	    --deamidate
	    #end if
            && mv filtered.xml perco.xml
	    #end if

            && mv perco.xml $output
    </command>
    
    <inputs>
            <param name="input" type="data" format="percout" label="Percolator output data" />
	    <conditional name="filterprot">
		    <param name="yesno" type="select" label="Filter on protein header?">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
		    </param>
		    <when value="no" />
		    <when value="yes">
			    <repeat name="headers" title="Protein class headers" help="All specified headers belong to same class and will be kept. Non-matching headers will be filtered out" >
				    <param name="pattern" type="text" label="Header pattern regex" help="E.g. ^ENSP" />
			   </repeat>
		    </when>
	    </conditional>
	    <conditional name="filteruni">
		    <param name="yesno" type="select" label="Filter unique peptides?">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
		    </param>
		    <when value="no" />
		    <when value="yes">
			    <param name="score" type="select" label="Score to use as filter">
				    <option value="svm">svm score</option>
				    <option value="pep">PEP</option>
				    <option value="q">q-value</option>
				    <option value="p">p-value</option>
			    </param>
		    </when>
	    </conditional>
	    <conditional name="filteruni">
		    <param name="yesno" type="select" label="Filter unique peptides?">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
		    </param>
		    <when value="no" />
		    <when value="yes"> 
			    <param name="maxlen" type="integer" label="Maximum allowed peptide length" help="Set to -1 for unlimited length" value="-1" />
			   <param name="minlen" type="integer" label="Minimum allowed peptide length" value="0" />
		    </when>
	    </conditional>
	    <conditional name="filterprot">
		    <param name="yesno" type="select" label="Filter whole protein matches?" help="With a whole protein lookup">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
		    </param>
		    <when value="no" />
		    <when value="yes"> 
			    <param name="fasta" type="data" format="fasta" label="Protein DB" help="Fasta file with proteins to remove peptide sequences from Percolator data" /> 
			    <param name="lookup" type="data" format="mslookupsql" label="Lookup with all peptides" help="Created from protein FASTA, containing all possible peptides of certain length" />
			    <param name="minlength" type="integer" label="Minimum length of peptides in experiment that will be filtered. Accidental peptides smaller than this will pass the filter." value="" />
			    <param name="deamidate" type="boolean" label="Deamidation" help="Also filters out peptides that are deamidated and not in the known DB"/>
			    <param name="forcetryp" type="boolean" label="Filter out tryptic peptides only" help="Peptides that match protein DB but are not tryptic (K/R before peptide in protein, K/R at peptide C-term) are considered novel" />
		   </when>
	    </conditional>
	    <conditional name="filterseq">
		    <param name="yesno" type="select" label="Filter by sequence?" help="With a sequence lookup">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
		    </param>
		    <when value="no" />
		    <when value="yes"> 
			    <param name="lookup" type="data" format="mslookupsql" label="known sequences" help="Sqlite DB containing sequences to be ignored. This file can be created by running msslookup" />
			    <param name="falloff" value="0" type="integer" label="Max amount of amino acids lost at N-terminal due to in-source fragmentation" help="Also filters peptides from result that partially match due to having lost residues N-terminally by MS"/>
			   <param name="deamidate" type="boolean" label="Deamidation" help="Also filters out peptides that are deamidated and not in the known DB"/>
		    </when>
	    </conditional>
    </inputs>
    
    <outputs>
        <data format="percout" name="output"/>
    </outputs>
    
  <help>
	  Filtering operations for percolator data. Use to filter out duplicate peptides
	  resulting from merged data (keeps the best scoring ones), peptides and PSMs
	  outside of certain length cutoffs, or peptides and PSMs which do not match
	  EXCLUSIVELY to a specified protein header. Two filters need a sequence lookup
	  SQLite file (can be made with msslookup), one filters on sequences in that
	  file, the other filters on whole protein sequences also in that lookup.
  <help>
</tool>
