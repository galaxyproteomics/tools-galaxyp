<tool id="protein_table_fdr" name="Calculate protein FDR"> 
    <requirements>
        <requirement type="package" version="2.2">msstitch</requirement>
	<requirement type="package">percolator</requirements> 
    </requirements>
  
    <description>using different methods</description>
    <command>
	    <![CDATA[
	    mssprottable bestpeptide -i '$targetproteins' -o targetbestpeptides.txt --peptable '$targetpeptable'
	    --scorecolpattern "$scorecol"
            #if $minlog
            --logscore
            #end if
	    #if $proteincolumn.value
	    --protcol $proteincolumn
	    #end if
            &&
	    mssprottable bestpeptide -i '$decoyproteins' -o decoybestpeptides.txt --peptable '$decoypeptable'
	    --scorecolpattern "$scorecol"
            #if $minlog
            --logscore
            #end if
	    #if $proteincolumn.value
	    --protcol $proteincolumn
	    #end if
	    &&
	    mssprottable
	    #if $qvality.type in ["pickfasta", "pickresult"]
	    pickqvality 
            #if str($qvality.type) == "pickfasta"
            --targetfasta $tfasta --decoyfasta $dfasta
	    #if $qvality.fastadelim
	    --fastadelim $qvality.fastadelim
	    #end if
	    #if $qvality.genefield
	    --genefield $qvality.genefield
	    #end if
            #end if
	    #else if $qvality.type in ["qvalue", "probability"]
	    qvality --feattype $qvality.type
	    #end if
	    #if $qoptions.yesno.value == "yes"
	    --qoptions
	    #if $qoptions.epsilon_step
	    ***epsilon-step $qoptions.epsilon_step
	    #end if
	    #if $qoptions.number_of_bins
	    ***number-of-bins $qoptions.number_of_bins
	    #end if
	    #if $qoptions.epsilon_cross_validation
	    ***epsilon-cross-validation $qoptions.epsilon_cross_validation
	    #end if
	    #if $qoptions.reverse.value == "true"
	    ***reverse
	    #end if
	    #if $qoptions.generalized.value == "true"
	    ***generalized
	    #end if
	    #end if
            -i targetbestpeptides.txt --decoyfn decoybestpeptides.txt
	    -o qvalityout.txt
	    &&
	    mssprottable fdr -i targetbestpeptides.txt -o '$output'
	    --qvality qvalityout.txt --scorecolpattern $scorecol
	    ]]>
    </command>
    
    <inputs>
      <param name="targetproteins" type="data" format="prottable" label="Target protein table"/>
      <param name="decoyproteins" type="data" format="prottable" label="Decoy protein table"/>
      <param name="targetpeptable" type="data" format="peptsv" label="Target peptide table"/>
      <param name="decoypeptable" type="data" format="peptsv" label="Peptide table"/>
      <param name="proteincolumn" type="integer" label="Peptide table column with protein accessions if not standard Master protein column" optional="true" />
      <param name="scorecol" type="text" label="Regular expression pattern to determine scorecolumn in peptide file" help="E.g. ^q-value if -log10 is used, or svm" />
      <param name="minlog" type="boolean" label="Use -log10 of a peptide's score" help="E.g. when using q-values to calculate best peptide Q-score" truevalue="true" falsevalue="false"/>

      <conditional name="qvality">
	      <param name="type" type="select" display="radio">
		      <option value="pickfasta">Picked FDR with FASTA</option>
		      <option value="pickresult">Picked FDR from protein table</option>
		      <option value="qvalue">Conventional FDR with best peptide</option>
		      <option value="probability">Conventional FDR with protein probability</option>
	      </param>
	      <when value="pickfasta">
		     <param name="tfasta" type="data" format="fasta" label="Target FASTA"
			     help="Must match decoy FASTA" />
		     <param name="dfasta" type="data" format="fasta" label="Decoy FASTA" help="Must match target FASTA" />
		     <param name="fastadelim" type="select" label="FASTA delimiter" optional="true" help="In case FASTA is not ENSEMBL or Uniprot you may be able to use a simple splitter to parse out the gene names. The delimiter is what splits the fields.">
			     <option value="pipe">| (pipe)</option>
			     <option value="tab">tab</option>
			     <option value="semicolon">; (semicolon)</option>
		     </param>
		     <param name="genefield" type="integer" label="Gene field number" optional="true" help="To be used together with FASTA delimiter, this is the number of the field in which the gene name is in. First field is nr. 1" />
	      </when>
	      <when value="pickresult" />
	      <when value="qvalue" />
	      <when value="probability" />

	<conditional name="qoptions">
		<param name="yesno" label="Change qvality defaults?" type="select" display="radio">
			<option value="yes">Yes</option>
			<option value="no">No</option>
		</param>
		<when value="yes">
			<param name="epsilon_step" type="float" min="0" max="1" label="qvality Epsilon step" help="The relative step size used as treshhold before cross validation error is calculated. A number between 0 and 1" optional="true" />
			<param name="number_of_bins" type="integer" min="1" max="2147483647" label="qvality Number of bins" help="The number of spline knots used when interpolating spline function. Default: 500" optional="true"/>
			<param name="epsilon_cross_validation" type="float" min="0" max="1" optional="true" label="qvality Epsilon cross validation" help="The relative crossvalidation step size used as treshhold before ending the iterations. A number between 0 and 1." />
			<param name="reverse" type="select" label="qvality Reverse" help="Indicating that the scoring mechanism is reversed, i.e. that low scores are better than higher scores">
			    <option value="false">No</option>
			    <option value="true">Yes</option>
			</param>
			<param name="generalized" type="select" label="qvality Generalized" help="Generalized target decoy competition, situations where PSMs known to more frequently be incorrect are mixed in with the correct PSMs">
			    <option value="false">No</option>
			    <option value="true">Yes</option>
			</param>
		</when>
		<when value="no" />
	</conditional>
    </inputs>
    
    <outputs>
        <data format="prottable" name="output"/>
    </outputs>

    <help>
	    This tool reads output from percolator's qvality tool and then adds FDR values
	    to the protein table, by matching protein scores to the qvality table and reading
	    the respective q-value and PEP.
    </help>

</tool>
