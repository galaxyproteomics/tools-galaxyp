<tool id="create_protein_table" name="Create protein table" version="1.0">
    <description>from PSMs</description>
    <requirements>
        <requirement type="package" version="2.2">msstitch</requirement>
    </requirements>
    <command>
            <![CDATA[
	    cut -f $accessioncol '$psmtable'|grep -v '\;'|sort|uniq > proteintable.txt
	    
	    #if $isoquant.yesno.value == "yes"
	        &&
	        msspsmtable isoquant -i '$psmtable' -o isoquant.txt --protcol $accessioncol --isobquantcolpattern '$isoquant.isobpattern' --denompatterns '$isoquant.denompatterns' --minint $isoquant.minint
		#if $isoquant.normalize.type != "false"
		    --normalize median
		    #if $isoquant.normalize.type == "medianother"
		        --norm-ratios $isoquant.normalize.norm_ratio_table
		    #end if
		#end if
	        &&
	        mv isoquant.txt proteintable.txt
	    #end if

	    #if $ms1quant.value == "yes"
	        &&
	        mssprottable ms1quant -i proteintable.txt -o ms1quanted.txt
	        --psmtable '$psmtable' --protcol '$accessioncol'
	        &&
	        mv ms1quanted.txt proteintable.txt
	    #end if

	    #if $probabilities.yesno.value == "yes"
	        mssprottable probability -i proteintable.txt -o protprob.txt 
	        --peptable $probabilities.peptable --protcol $probabilities.accessioncol
	        &&
	        mv protprob.txt proteintable.txt
	    #end if

	    && mv proteintable.txt '$output'
            ]]>
    </command>
    <inputs>
	    <param name="psmtable" type="data" format="mzidtsv" label="PSM table" help="Must contain isobaric ratios and accession of protein/gene/peptide" />
	   <param name="accessioncol" type="integer" value="" label="Accession column number in PSM table containing the proteins, genes, peptides to quantify" />
	    <conditional name="isoquant">
		    <param name="yesno" type="select" label="Use isobaric data?">
                            <option value="yes">Yes</option>
                            <option value="no">No</option>
		    </param>
		    <when value="no" />
		    <when value="yes"> 
			    <param name="isobpattern" type="text" label="Pattern for isobaric quant columns in PSM table" help="Regex to find quant columns, e.g. tmt10plex, itraq8plex, plex"/>
			    <param name="denompatterns" type="text" label="Patterns for denominator isobaric quant columns in PSM table" help="Multiple are separated with space, e.g. _126 _127N" />
			   <param name="minint" type="float" value="0.1" label="Minimum intensity of PSM channel to include" />
			   <conditional name="normalize">
				   <param name="type" type="select" label="Use isobaric data?">
					   <option value="medianself">Median center using own ratios</option>
					   <option value="medianother">Median center using ratios from other table</option>
					   <option value="false">No</option>
				  </param>
				  <when value="false" />
				  <when value="medianself" />
				  <when value="medianother" >
					  <param name="norm_ratio_table" label="Tabular datatable with ratios" help="Same isobaric quant columns should occur" />
				  </when>
			   </conditional>
		    </when>
	    </conditional>
	    <param name="ms1quant" type="boolean" label="Calculate MS1 quant?" help="Average of 3 highest PSM MS1 areas for a protein" />
	    <conditional name="probabilities">
		    <param name="yesno" type="select" label="Add protein probabilities?" help="As in Nesvizhskii et al. 2003">
                            <option value="true">Yes</option>
                            <option value="false">No</option>
		    </param>
		    <when value="false" />
		    <when value="true"> 
			    <param name="peptable" type="data" format="peptsv" label="Peptide table" />
			    <param name="accessioncol" type="integer" label="Peptide table column with protein accessions if not standard Master protein column" optional="true" />
		   </when>
	    </conditional>
    </inputs>
    
    <outputs>
        <data format="tabular" name="output"/>
    </outputs>
    <tests>
	    <test>
		    <param name="psmtable" value="fullpsmtable.txt" />
		    <param name="accessioncol" value="14" />
		    <param name="ms1quant" value="true" />
		    <param name="isoquant|yesno" value="true" />
		    <param name="isoquant|isobpattern" value="tmt10plex" />
		    <param name="isoquant|denompattern" value="tmt10plex" />
		    <param name="isoquant|minint" value="0.2" />
		    <param name="isoquant|normalize|type" value="medianother" />
		    <param name="isoquant|normalize|norm_ratio_table" value="protein_ratios.txt" />
		    <param name="probabilities|yesno" value="true" />
		    <param name="probabilities|peptable" value="peptide_table" />
		    <param name="probabilities|accessioncol" value="13" />
		    <output name="output" value="protein_table.txt" />
	    </test>
    </tests>
    <help>
	    Creates a protein table from PSM and peptide tables. Choose for each entry 
	    to add isobaric quant, precursor quant, probabilities.
    </help>
</tool>
