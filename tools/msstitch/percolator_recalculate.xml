<tool id="percolator_recalculate" name="Recalculate FDR" version="1.1">
    <description>on remodeled percolator data</description>
    <requirements>
        <requirement type="package" version="2.5">msstitch</requirement>
        <requirement type="package" version="3.1">percolator</requirement>
    </requirements>
    <command detect_errors="exit_code">
        <![CDATA[
        msspercolator qvality -i '$target' --decoyfn '$decoy' --feattype $feature -o qvalityout.txt
        #if $qoptions.yesno == "true"
            --qoptions
            #if $qoptions.epsilon_step
                ***epsilon-step $qoptions.epsilon_step
            #end if
            #if $qoptions.number_of_bins
                ***number-of-bins $qoptions.number_of_bins
            #end if
            #if $qoptions.epsilon_cross_validation
                ***epsilon-cross-validation $qoptions.epsilon_cross_validation
            #end if
            #if $qoptions.reverse == "true"
                ***reverse
            #end if
            #if $qoptions.generalized == "true"
                ***generalized
            #end if
        #end if
        &&
        msspercolator reassign -i '$target' -o '$targetoutput'
        --qvality qvalityout.txt --feattype $feature
        &&
        msspercolator reassign -i '$decoy' -o '$decoyoutput'
        --qvality qvalityout.txt --feattype $feature
        ]]>
    </command>
    
    <inputs>
        <param name="target" type="data" format="percout" label="Percolator target data" />
        <param name="decoy" type="data" format="percout" label="Percolator decoy data" />
        <param name="feature" type="select" label="What to reassign statistics on">
            <option value="psm">PSMs</option>
            <option value="peptide">peptides</option>
        </param>
        <conditional name="qoptions">
            <param name="yesno" label="Change qvality defaults?" type="select" display="radio">
                <option value="true">Yes</option>
                <option value="false">No</option>
            </param>
            <when value="true">
                <param name="epsilon_step" type="float" min="0" max="1" label="qvality Epsilon step" help="The relative step size used as treshhold before cross validation error is calculated. A number between 0 and 1" optional="true" />
                <param name="number_of_bins" type="integer" min="1" max="2147483647" label="qvality Number of bins" help="The number of spline knots used when interpolating spline function. Default: 500" optional="true"/>
                <param name="epsilon_cross_validation" type="float" min="0" max="1" optional="true" label="qvality Epsilon cross validation" help="The relative crossvalidation step size used as treshhold before ending the iterations. A number between 0 and 1." />
                <param name="reverse" type="boolean" label="qvality Reverse" help="Indicating that the scoring mechanism is reversed, i.e. that low scores are better than higher scores" />
                <param name="generalized" type="boolean" label="qvality Generalized" help="Generalized target decoy competition, situations where PSMs known to more frequently be incorrect are mixed in with the correct PSMs" />
            </when>
            <when value="false" />
        </conditional>
    </inputs>
    
    <outputs>
        <data format="percout" name="targetoutput" label="Recalculated percolator target" />
        <data format="percout" name="decoyoutput" label="Recalculated percolator decoy" />
    </outputs>
    <tests>
        <test>
            <param name="target" value="perco_filterlen_target.xml" />
            <param name="decoy" value="perco_filterlen_decoy.xml" />
            <param name="feature" value="psm" />
            <param name="qoptions|yesno" value="false" />
            <output name="targetoutput" value="perco_target_psmrecalc.xml" />
            <output name="decoyoutput" value="perco_decoy_psmrecalc.xml" />
        </test>
        <test>
            <param name="target" value="perco_filterlen_target.xml" />
            <param name="decoy" value="perco_filterlen_decoy.xml" />
            <param name="feature" value="peptide" />
            <param name="qoptions|yesno" value="true" />
            <param name="qoptions|epsilon_step" value="0.5" />
            <param name="qoptions|number_of_bins" value="600" />
            <param name="qoptions|epsilon_cross_validation" value="0.5" />
            <param name="qoptions|reverse" value="false" />
            <param name="qoptions|generalized" value="false" />
            <output name="targetoutput" value="perco_target_peprecalc_options.xml" />
            <output name="decoyoutput" value="perco_decoy_peprecalc_options.xml" />
        </test>
    </tests>

    <help>
        Recalculate q-values and PEP on percolator data for PSMs or peptides. This uses qvality
        to recalculate changed (e.g. filtered) percolator data statistics. Inputs and outputs
        are a target and a decoy dataset.
    </help>
    <citations>
        <citation type="doi">10.1038/nmeth1113</citation>
    </citations>
</tool>
