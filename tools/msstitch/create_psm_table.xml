<tool id="process_psmtable" name="Process PSM table" version="1.0">
    <description>merges, filters, adds data</description>
    <requirements>
        <requirement type="package" version="2.2">msstitch</requirement>
    </requirements>
    <command>
	    <![CDATA[
	    #if $percolator.yesno == "true" and $psms.multiple == "true"
    	        #for $fn, $mzidfn in zip($psms.psmtables.keys(), $percolator.mzidentmls.keys())
    	            msspsmtable percolator -i '$psms[$fn]' --mzid '$percolator.mzidentmls[$mzidfn]' -o '$fn'
                &&
	        #end for
	    #else if $psms.multiple == "true" and $percolator.yesno == "false"
	        #for $fn in $psms.psmtables.keys()
	            ln -s '$psms[$fn]' '$fn'
	            &&
	        #end for
	    #else if $percolator.yesno == "true"
	        msspsmtable percolator -i '$psms.psmtable' --mzid '$percolator.mzidentmls[$mzidfn]' -o singlepsmtable.txt
	        &&
	    #else if $psms.multiple == "false" and $percolator.yesno == "false"
	        ln -s '$psms.psmtable singlepsmtable.txt
	        &&
	    #end if

	    #if $psms.multiple == "true"
	        msspsmtable merge -o mergedpsms.txt -i
                #for $fn in $psms.psmtables.keys()
                    '$fn'
                #end for
	    #else
	        ln -s singlepsmtable.txt mergedpsms.txt
	    #end if

	    &&
	    #if $filter.yesno == "true"
	        msspsmtable conffilt -i mergedpsms.txt -o filteredpsms.txt
	        --confidence-col $filter.confcol --confidence-lvl $filter.conflvl 
	        --confidence-better $filter.confbet
	    #else
	        ln -s mergedpsms.txt filteredpsms.txt
	    #end if
	    
	    &&
	    cp '$lookup' psmlookup.sql
	    &&
	    msslookup psms -i filteredpsms.txt --dbfile psmlookup.sql
            #if $speccol
                --spectracol $speccol 
            #end if
            #if $dbase
                --fasta $dbase
            #end if
	    #if $mapfn
	        --map $mapfn
	    #end if
	    #if $decoy
	        --decoy
	    #end if
	    #if $fastadelim
	        --fastadelim $fastadelim
	    #end if
	    #if $genefield
	        --genefield $genefield
	    #end if
	    
	    &&
	    msspsmtable specdata -i filemappedpsms.txt -o specdatapsms.txt --dbfile psmlookup.sql

	    &&
            #if $isobaric == "true" or $precursorquant == "true"
	        msspsmtable quant -i specdatapsms.txt -o quantpsms.txt --dbfile psmlookup.sql
                #if $isobaric == "true"
                    --isobaric
                #end if
                #if $precursorquant == "true"
                    --precursor
                #end if
	    #else
	        ln -s specdatapsms.txt quantpsms.txt
	    #end if
	    
	    &&
	    #if $genes == "true"
	        msspsmtable genes -i quantpsms.txt -o genepsms.txt --dbfile psmlookup.sql
	    #else
	        ln -s quantpsms.txt genepsms.txt
	    #end if

	    &&
	    #if $proteingroup.yesno == "true"
	        msslookup proteingroup -i filemappedpsms.txt --dbfile psmlookup.sql
	        &&
	        msspsmtable proteingroup -i quantpsms.txt --dbfile psm_lookup.sql -o pgrouped.txt
	    #else
	        ln - s quantpsms.txt pgrouped.txt
	    #end if

	    &&
	    ln -s pgrouped.txt '$output'
	    &&
	    mv psmlookup.sql '$lookupoutput'
           ]]>	    
    </command>
    <inputs>
	    <conditional name="psms">
		    <param type="select" name="multiple" label="Multiple tables in collection?">
			    <option value="true">Yes</option>
			    <option value="false">Yes</option>
		    </param>
		    <when value="true"> 
			    <param name="psmtables" type="data_collection" format="mzidtsv" label="Search table from MSGF+"/>
		    </when>
		    <when value="false"> 
			   <param name="psmtable" type="data" format="mzidtsv" label="Search table from MSGF+"/>
		    </when>
	    </conditional>
	    <param name="speccol" type="integer" value="1" label="Spectra file column number" />
	    <param name="dbase" type="data" format="fasta" label="Fasta database used to search" optional="true"/>
	    <param name="fastadelim" type="select" label="FASTA delimiter" optional="true" help="In case FASTA is not ENSEMBL or Uniprot you may be able to use a simple splitter to parse out the gene names. The delimiter is what splits the fields.">
		    <option value="pipe">| (pipe)</option>
		    <option value="tab">tab</option>
		    <option value="semicolon">; (semicolon)</option>
	    </param>
	    <param name="genefield" type="integer" label="Gene field number" optional="true" help="To be used together with FASTA delimiter, this is the number of the field in which the gene name is in. First field is nr. 1" />
	    <param name="mapfn" type="data" format="martmap" optional="true" label="Biomart map containing genes/symbols/descriptions" />
	    <param name="decoy" type="boolean" label="Is the PSM table a decoy?" help="Only necessary to specify in case a ENSEML fasta and Biomart map are supplied" /> 
	   
	   <conditional name="percolator">
		    <param type="select" name="yesno" label="Add percolator data?">
			    <option value="true">Yes</option>
			    <option value="false">Yes</option>
		    </param>
		    <when value="true"> 
			    <param name="mzidentmls" type="data" format="mzid" label="Percolated MSGF+ mzIdentML data" help="Make sure to select a collection here when the PSM table input is a collection" />
		    </when>
		    <when value="false" /> 
	    </conditional>

	    <conditional name="filter">
		    <param type="select" name="yesno" label="Filter PSM table?">
			    <option value="true">Yes</option>
			    <option value="false">Yes</option>
		    </param>
		    <when value="true"> 
			    <param name="confcol" type="integer" value="" label="TSV column with confidence values to filter on" />
			    <param name="conflvl" type="float" value="" label="Threshold value" help="Lowest or highest value to include in output" />
			    <param name="confbet" type="select" display="radio" label="Better values are:">
				    <option value="lower">Lower</option>
				    <option value="higher">Higher</option>
			    </param>
		    </when>
		    <when value="false" />
	    </conditional>

	    <param name="isobaric" type="boolean" label="Add isobaric quant intensities to PSM table" help="If it has been stored in PSM lookup" />
	    <param name="precursorquant" type="boolean" label="Add precursor quant data to PSM table" help="If it has been stored in PSM lookup" />
	    <param name="genes" type="boolean" label="Add genes to PSM table" help="If genes have been stored in PSM lookup" />
	    <param name="proteingroup" type="boolean" label="Output protein groups?" />
    </inputs>
    
    <outputs>
        <data format="mzidtsv" name="output"/>
        <data format="sqlite" name="lookupoutput"/>
    </outputs>
    <tests>
	    <test>
		    <param name="psms|multiple" value="true" />
		    <param name="psms|psmtables">
			    <collection type="list">
				    <element name="psmtable1" value="psmtable.txt" />
				    <element name="psmtable2" value="psmtable.txt" />
			   </collection>
		    </param>
		    <param name="speccol" value="1" />
		    <param name="dbase" value="db.fasta" />
		    <param name="mapfn" value="biomart.map" />
		    <param name="decoy" value="false" />
		    <param name="percolator|yesno" value="true" />
		    <param name="percolator|mzidentmls" >
			    <!-- FIXME correct names! -->
			    <collection type="list">
				    <element name="mzid1" value="psms.mzid" />
				    <element name="mzid2" value="psms.mzid" />
			    </collection>
		    </param>
		    <param name="filter|yesno" value="true" />
		    <param name="filter|confcol" value="18" />
		    <param name="filter|conflvl" value="0.01" />
		    <param name="filter|confbet" value="lower" />
		    <param name="isobaric" value="true" />
		    <param name="precursorquant" value="true" />
		    <param name="genes" value="true" />
		    <param name="proteingroup" value="true" />
		    <output name="output" value="fullpsmtable.txt" />
		    <output name="lookupoutput" value="proteingrouped_ensemblpsms.sql" />
	    </test>
	    <test>
		    <param name="psms|multiple" value="false" />
		    <param name="psms|psmtable" value="psmtable.txt" />
		    <param name="speccol" value="1" />
		    <param name="dbase" value="db.fasta" />
		    <param name="decoy" value="false" />
		    <param name="percolator|yesno" value="true" />
			    <!-- FIXME correct mzid name! -->
		    <param name="percolator|mzidentmls" value="psms.mzid" />
		    <param name="filter|yesno" value="false" />
		    <param name="isobaric" value="false" />
		    <param name="precursorquant" value="false" />
		    <param name="genes" value="false" />
		    <param name="proteingroup" value="false" />
		    <output name="output" value="minimal_psmtable_perco.txt" />
		    <output name="lookupoutput" value="minimal_psms_perco.sql" />
	    </test>
	    <test>
		    <param name="psms|multiple" value="false" />
		    <param name="psms|psmtable" value="psmtable.txt" />
		    <param name="speccol" value="1" />
		    <param name="dbase" value="db.fasta" />
		    <param name="decoy" value="false" />
		    <param name="percolator|yesno" value="false" />
		    <param name="filter|yesno" value="false" />
		    <param name="isobaric" value="false" />
		    <param name="precursorquant" value="false" />
		    <param name="genes" value="false" />
		    <param name="proteingroup" value="false" />
		    <output name="output" value="minimal_psmtable.txt" />
		    <output name="lookupoutput" value="minimal_psms.sql" />
	    </test>
	    <test>
		    <param name="psms|multiple" value="true" />
		    <param name="psms|psmtables">
			    <collection type="list">
				    <element name="psmtable1" value="psmtable.txt" />
				    <element name="psmtable2" value="psmtable.txt" />
			   </collection>
		    </param>
		    <param name="speccol" value="1" />
		    <param name="dbase" value="db.fasta" />
		    <param name="decoy" value="false" />
		    <param name="percolator|yesno" value="false" />
		    <param name="filter|yesno" value="false" />
		    <param name="isobaric" value="false" />
		    <param name="precursorquant" value="false" />
		    <param name="genes" value="false" />
		    <param name="proteingroup" value="false" />
		    <output name="output" value="minimal_psmtable.txt" />
		    <output name="lookupoutput" value="minimal_psms.sql" />
	    </test>
	    <test>
		    <param name="psms|multiple" value="false" />
		    <param name="psms|psmtable" value="psmtable.txt" />
		    <param name="speccol" value="1" />
		    <param name="dbase" value="genefield_db.fasta" />
		    <param name="fastadelim" value=";" />
		    <param name="genefield" value="2" />
		    <param name="decoy" value="false" />
		    <param name="percolator|yesno" value="false" />
		    <param name="filter|yesno" value="false" />
		    <param name="isobaric" value="false" />
		    <param name="precursorquant" value="false" />
		    <param name="genes" value="false" />
		    <param name="proteingroup" value="false" />
		    <output name="output" value="minimal_psmtable.txt" />
		    <output name="lookupoutput" value="minimal_psms.sql" />
	    </test>
    </tests>
    <help>
	    This tool runs a series of commands to refine (MSGF+-derived) PSM tables with data such
	    as uploaded spectra file name, retention time, quant intensities, protein groups, etc. 
	    It outputs a refined PSM table as well as an SQLite lookup database for 
	    further use by msstitch tools.
    </help>
</tool>
