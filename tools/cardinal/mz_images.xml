<tool id="cardinal_mz_images" name="MSI mz images" version="@VERSION@.0">
    <description>
        mass spectrometry imaging m/z heatmaps
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <expand macro="requirements">
        <requirement type="package" version="2.3">r-gridextra</requirement>
    </expand>
    <command detect_errors="aggressive">
<![CDATA[
        @INPUT_LINKING@
        cat '${MSI_heatmaps}' &&
        Rscript '${MSI_heatmaps}'
]]>
    </command>
    <configfiles>
        <configfile name="MSI_heatmaps"><![CDATA[

################################# load libraries and read file #################

library(Cardinal)
library(gridExtra)
##library(lattice)

@READING_MSIDATA_FULLY_COMPATIBLE@

@DATA_PROPERTIES@

##in case it exists, remove z-dimension:
coord(msidata)\$z <- NULL

##################################### read and filter input m/z ##############

input_list = read.delim("$calibrant_file", header = $calibrant_header, stringsAsFactors = FALSE)
input_list = input_list[,c($mz_column, $name_column)]

### calculate how many input m/z are valid: 
inputmasses = input_list[input_list[,1]>minmz & input_list[,1]<maxmz,]
inputmz = as.numeric(inputmasses[,1])
inputnames = as.character(inputmasses[,2])


############################## PDF #############################################
################################################################################

pdf("heatmaps.pdf", fonts = "Times", pointsize = 12)
plot(0,type='n',axes=FALSE,ann=FALSE)

#if not $filename:
    #set $filename = $infile.display_name
#end if

title(main=paste("\nHeatmap images\n\n", "Filename:\n", "$filename"))

new_row = data.frame(paste0("# valid m/z in \n", "$calibrant_file.display_name"), paste0(length(inputmz), "/", length(input_list[,1])))
colnames(new_row) = c("properties", "values")
property_df = rbind(property_df, new_row)

grid.table(property_df, rows= NULL)

############################# II) images ####################################

colourpalette = cpal(palette = "$colorscale")

image_contrast = "$image_contrast"
if (image_contrast == "NULL") {
  image_contrast <- NULL
}

image_smoothing = "$image_smoothing"
if (image_smoothing == "NULL") {
  image_smoothing <- NULL
}

### only plot images when file has features and pixels:
par(mar=c(0,0,0,0), oma=c(0,0,0,1)) ## margin for image legend

#if str($light_mode) == "white":
    matter::vizi_style(style= "light") #lightmode()
#else
    matter::vizi_style(style= "dark") #darkmode()
#end if

if (ncol(msidata)>0 & nrow(msidata) >0){
    if (length(inputmz) != 0){
        for (mass in 1:length(inputmz)){
                print(image(msidata,
                mz=inputmz[mass],
                tolerance = $plusminus_dalton,
                unit = "$plusminus_unit",
                enhance = image_contrast,
                smooth = image_smoothing,
                scale = $scale_factor,
                key=$colorkey,
                col=colourpalette,
                alphapow = $alpha_power,
                ylim= c(maximumy+1,minimumy-1),
                xlim= c(minimumx-1,maximumx+1)))
                title(inputnames[mass], adj = 0.5, line = 1)}


        ## optional svg output with original coordinates
        #if $svg_pixelimage:
            print("svg pixel image")
            ## reverse y axis for svg output = correct order and nice svg image
            coord(msidata)\$y <- max(coord(msidata)\$y) - coord(msidata)\$y + 1
            msidata = as(msidata,"MSImagingExperiment")


            svg(file="svg_pixel_output.svg", width=maximumx, height=maximumy)
            par(mar=c(0,0,0,0), oma=c(0,0,0,0)) ##, xaxt = "n", yaxt = "n")## no margin for svg

	    #if str($light_mode) == "white":
	        matter::vizi_style(style= "light") #lightmode()
	    #else
	        matter::vizi_style(style= "dark") #darkmode()
	    #end if
            svg_image = image(msidata,
                    strip=FALSE,
                    mz = inputmz[1],
                    tolerance = $plusminus_dalton,
                    unit = "$plusminus_unit",
                    col=colourpalette,
                    scale = $scale_factor,
                    alphapow = $alpha_power,
                    key = FALSE,
                    axes=FALSE,
                    xlab=NA,
                    ylab=NA,
                    ##main=NULL,
                    enhance = image_contrast,
                    smooth = image_smoothing)
            svg_image\$labels <- NULL
            print(svg_image)
            ##title(main = "")
            dev.off()
        #end if

        ## optional overlay all input m/z in one image
        #if str($overlay_cond.overlay_selection) == "yes_overlay":

        #set $color_string = ','.join(['"%s"' % $color.feature_color for $color in $overlay_cond.colours])
        colourvector = c($color_string)
            print(image(msidata, mz=inputmz, 
                  tolerance = $plusminus_dalton,
                  unit = "$plusminus_unit",
                  col=colourvector,
                  alphapow = $alpha_power,
                  enhance = image_contrast,
                  smooth = image_smoothing,
                  superpose=TRUE,
                  main="overlay of all m/z",
                  key=FALSE,
                  ylim= c(maximumy+1,minimumy-1),
                  xlim= c(minimumx-1,maximumx+1)))

             legend("$overlay_cond.legend_position",
                      fill=colourvector,
                      legend=as.numeric(inputmz))
        #end if

    } else {print("The input m/z were invalid")}
    dev.off()
}else{
    print("input file has no features or pixels left")
dev.off()
}


    ]]></configfile>
    </configfiles>
    <inputs>
        <expand macro="reading_msidata"/>
        <expand macro="pdf_filename"/>
        <expand macro="reading_2_column_mz_tabular"/>

        <param name="plusminus_dalton" value="0.25" type="float" label="plusminus ppm or m/z" help="m/z or ppm range to add on either side of the given m/z to create a window in which the mean of all intensities will be computed"/>
        <param name="plusminus_unit" type="select" label="unit" help="Select whether the plusminus tolerance is given in m/z or ppm.">
            <option value="mz" selected="TRUE" >mz</option>
            <option value="ppm" >ppm</option>
        </param>
        <param name="image_contrast" type="select" label="Contrast enhancement" help="The 'histogram' equalization method flatterns the distribution of intensities. The 'adaptive' equalization performs contrast-limited adaptive histogram equalization to enhance local contrast, but avoid local noise.">
            <option value="NULL" selected="True">none</option>
            <option value="histogram">histogram</option>
            <option value="adapt">adaptive</option>
        </param>
        <param name="image_smoothing" type="select" label="Image smoothing" help="The 'gaussian' smoothing method smooths images with a simple gaussian kernel. The 'adaptive' method uses bilateral filtering to preserve edges">
            <option value="NULL" selected="True">none</option>
            <option value="gaussian">gaussian</option>
            <option value="adaptive">adaptive</option>
            <option value="mean">mean</option>
            <option value="diffusion">diffusion</option>
            <option value="ma">moving average</option>
        </param>
        <param name="scale_factor" type="boolean" checked="FALSE" truevalue="TRUE" falsevalue="FALSE" label="Data scaling" help="If multiple images are plotted, should they be scaled to the same intensity scale?" />
        <param name="colorscale" type="select" display="radio" label="Colorscale">
            <option value="viridis" selected="True">viridis</option>
            <option value="plasma">plasma</option>
            <option value="inferno">inferno</option>
        </param>
        <param name="light_mode" type="select" display="radio" label="Image Background">
            <option value="white" selected="True">white</option>
            <option value="black">black</option>
        </param>
        <param name="alpha_power" type="float" value="1" label="Alpha power" help="Opacity scaling factor (1 is linear)"/>
        <param name="colorkey" type="boolean" checked="True" truevalue="TRUE" falsevalue="FALSE" label="Display colorkey in plot"/>
        <param name="svg_pixelimage" type="boolean" label="Export first valid m/z from tabular file as SVG"/>
        <conditional name="overlay_cond">
            <param name="overlay_selection" type="select" label="Overlay image">
                <option value="no_overlay" selected="True">no</option>
                <option value="yes_overlay">yes</option>
            </param>
            <when value="no_overlay"/>
            <when value="yes_overlay">
            <repeat name="colours" title="Colours for the plots" min="1" max="50">
                <param name="feature_color" type="color" label="Colours" value="#ff00ff" help="Numbers of colours should be the same as number of m/z in tabular file">
                  <sanitizer>
                    <valid initial="string.letters,string.digits">
                      <add value="#" />
                    </valid>
                  </sanitizer>
                </param>
            </repeat>
            <param name="legend_position" type="select" display="radio" label="Position of legend">
                <option value="topright" selected="True">topright</option>
                <option value="top">top</option>
                <option value="topleft">topleft</option>
                <option value="left">left</option>
                <option value="bottomleft">bottomleft</option>
                <option value="bottom">bottom</option>
                <option value="bottomright">bottomright</option>
                <option value="right">right</option>
            </param>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data format="pdf" name="plots" from_work_dir="heatmaps.pdf" label="${tool.name} on ${on_string}: results"/>
        <data format="svg" name="svg_output" from_work_dir="svg_pixel_output.svg" label="${tool.name} on ${on_string}: image.svg">
            <filter>svg_pixelimage</filter>
        </data>
    </outputs>
    <tests>
        <test expect_num_outputs="1">
            <expand macro="infile_imzml"/>
            <param name="calibrant_file" value="inputpeptides.tabular" ftype="tabular"/>
            <param name="mz_column" value="1"/>
            <param name="name_column" value="2"/>
            <param name="plusminus_dalton" value="0.25"/>
            <param name="filename" value="Testfile_imzml"/>
            <param name="image_contrast" value="histogram"/>
            <param name="colorkey" value="True"/>
            <output name="plots" file="Heatmaps_imzml.pdf" ftype="pdf" compare="sim_size"/>
        </test>
        <test expect_num_outputs="2">
            <expand macro="infile_analyze75"/>
            <param name="calibrant_file" value="inputpeptides2.tabular" ftype="tabular"/>
            <param name="mz_column" value="1"/>
            <param name="name_column" value="1"/>
            <param name="plusminus_dalton" value="0.5"/>
            <param name="filename" value="Testfile_analyze75"/>
            <param name="colorscale" value="magma"/>
            <param name="image_smoothing" value="gaussian"/>
            <param name="colorkey" value="True"/>
            <param name="svg_pixelimage" value="True"/>
            <output name="plots" file="Heatmaps_analyze75.pdf" ftype="pdf" compare="sim_size"/>
            <output name="svg_output" file="analyze75.svg" ftype="svg" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <param name="infile" value="preprocessed.RData" ftype="rdata"/>
            <param name="calibrant_file" value="inputpeptides.tabular" ftype="tabular"/>
            <param name="mz_column" value="1"/>
            <param name="name_column" value="2"/>
            <param name="plusminus_dalton" value="0.5"/>
            <param name="colorkey" value="True"/>
            <param name="filename" value="Testfile_rdata"/>
            <output name="plots" file="Heatmaps_rdata.pdf" ftype="pdf" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <param name="infile" value="empty_spectra.rdata" ftype="rdata"/>
            <param name="calibrant_file" value="inputpeptides2.tabular" ftype="tabular"/>
            <param name="mz_column" value="1"/>
            <param name="name_column" value="1"/>
            <param name="plusminus_dalton" value="0.5"/>
            <param name="colorscale" value="plasma"/>
            <param name="colorkey" value="False"/>
            <param name="filename" value="Testfile_rdata"/>
            <output name="plots" file="Heatmaps_LM8_file16.pdf" ftype="pdf" compare="sim_size"/>
        </test>
        <test expect_num_outputs="1">
            <expand macro="processed_infile_imzml"/>
            <conditional name="processed_cond">
                <param name="processed_file" value="processed"/>
                <param name="accuracy" value="200"/>
                <param name="units" value="ppm"/>
            </conditional>
            <param name="calibrant_file" value="inputpeptides.tabular" ftype="tabular"/>
            <param name="mz_column" value="1"/>
            <param name="name_column" value="2"/>
            <param name="light_mode" value="black"/>
            <conditional name="overlay_cond">
                <param name="overlay_selection" value="yes_overlay"/>
                <repeat name="colours">
                    <param name="feature_color" value="#ff00ff"/>
                </repeat>
                <repeat name="colours">
                    <param name="feature_color" value="#1f497d"/>
                </repeat>
                <repeat name="colours">
                    <param name="feature_color" value="#00b050"/>
                </repeat>
                <param name="legend_position" value="topleft"/>
            </conditional>
            <output name="plots" file="Heatmaps_processed.pdf" ftype="pdf" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[

@CARDINAL_DESCRIPTION@

-----

This tool uses the Cardinal image function to plot the intensity distribution of m/z features of mass spectrometry imaging data. 

@MSIDATA_INPUT_DESCRIPTION@

@MZ_2COLS_TABULAR_INPUT_DESCRIPTION@


**Tips** 

- In case tabular file cannot be selected in drop-down menu: Datatype in Galaxy must be tabular otherwise file will not appear in selection window (if Galaxy auto-detection was wrong, datatype can be changed by pressing the pen button (edit attributes))
- The contrast enhance and image smoothing functions require a certain number (about 2%) of m/z features with intensities > 0 across all spectra

**Output**

- Single Pdf with the heatmap images
- optional: svg file with the heatmap of the first valid m/z in the tabular file


    ]]>
    </help>
    <expand macro="citations"/>
</tool>
