<tool id="i2nca_region_qc" name="i2nca ROI QC Report" version="@TOOL_VERSION@+galaxy@GALAXY_VERSION@">
    <description>
        Create a Quality Control report for different Regions of Interest (ROI) for any kind of .imzML file.
        Supply a tsv file with x and y annotation for the regions.
        Different metrics will be visualized as a pdf report.
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <container type="docker">@BIOCONTAINER_VERSION@</container>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
    cp '${infile.extra_files_path}/imzml' indata.imzML &&
    cp '${infile.extra_files_path}/ibd' indata.ibd &&

    #if $with_tsv_annotation.add == 'Yes':
        'i2nca_region_qc' 'indata.imzML' './data' '$with_tsv_annotation.tsv_annotation'
    #else:
        'i2nca_region_qc' 'indata.imzML' './data' 'None'
    #end if
    ]]></command>
    <inputs>
        <param name="infile" type="data" format="imzml" label="MSI data" help="Load the imzML file (as Composite) on which the QC should be performed"/>
        <conditional name="with_tsv_annotation">
            <param name="add" label="Use an existing ROI annotation?" type="select">
                <option value="Yes"/>
                <option value="No"/>
            </param>
            <when value="Yes">
                <param name="tsv_annotation" label="ROI annotation as tsv file" type="data" format="tsv" help="Load a .tsv file for ROI annoation. \n                        This file needs three columns with &quot;x&quot;, &quot;y&quot; and &quot;annotation&quot;.                        Please use the origin (0|0) to refence the pixel coordinates."/>
            </when>
            <when value="No"/>
        </conditional>
    </inputs>
    <outputs>
        <data name="RegionQC" label="Region QC report on ${on_string}" from_work_dir="data_region_QC.pdf" format="pdf"/>
        <data name="AutomaticAnnotation" label="AutoROI annotation" from_work_dir="dataannotated_regions.tsv" format="tsv">
            <filter> with_tsv_annotation['add'] == 'No'</filter>
        </data>
    </outputs>
    <tests>
        <!-- Test 1: QC on cp without annotation-->
        <test expect_num_outputs="1">
            <expand macro="cp_infile"/>
            <conditional name="with_tsv_annotation">
                <param name="add" value="No"/>
            </conditional>
            <output name="RegionQC" file="Region_QC_Report_CP.pdf" compare="sim_size"/>
        </test>
        <!-- Test 2: QC on pc without annotation-->
        <test expect_num_outputs="2">
            <expand macro="pc_infile"/>
            <conditional name="with_tsv_annotation">
                <param name="add" value="Yes"/>
                <param name="tsv_annotation" value="regions.tsv" ftype="tsv"/>
            </conditional>
            <output name="RegionQC" file="Region_QC_Report_PC.pdf" compare="sim_size"/>
            <output name="AutomaticAnnotation" file="AutoROI_Annotation_PC.tsv" lines_diff="0"/>
        </test>
    </tests>
    <help><![CDATA[
        @I2NCA_DESCRIPTION@
    
        This tool performs a quality control report generation on any imzml file. 
        In the report, the signal from one or more regions of interest can be compared with each other.

    
        **Input data**
        
    
        @MSIDATA_INPUT_DESCRIPTION@
        
        ROI annotation: Please provide a list of ROI annotations as tsv file:
        - The file needs three columns with 'x', 'y' and 'annotation' headers.
        - The x and y annotations should be aligned so that the full file has the origin (0|0).
        - All rows with the same string as 'annotation' are grouped to one ROI.

        
    ]]></help>
    <citations>
        <expand macro="citation_i2nca"/>
        <expand macro="citation_m2aia"/>
    </citations>
</tool>
