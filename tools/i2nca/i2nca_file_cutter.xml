<tool id='i2nca_splitter' name='Split a imzML file into smaller files with i2nca' version='@TOOL_VERSION@+galaxy@GALAXY_VERSION@'>

    <description>
        Split an imzML file into different smaller flies based on a ROI annoation.
    </description>
        
        <macros>
        <import>macros.xml</import>
        </macros>
        
        <requirements>
            <container type='docker'>@BIOCONTAINER_VERSION@</container>
        </requirements>

    
        <command detect_errors='exit_code'><![CDATA[

        cp '${infile.extra_files_path}/imzml' indata.imzML &&
        cp '${infile.extra_files_path}/ibd' indata.ibd &&
    
        'i2nca_file_splitter' 'indata.imzML' './outdata_' '$tsv_annotation' &&

        ls -a . &&

        mkdir $outfile_a.files_path &&
        mv ./outdata_A.imzML '${os.path.join($outfile_a.files_path, 'outfile_A.imzml')}' | true &&
        mv ./outdata_A.ibd '${os.path.join($outfile_a.files_path, 'outfile_A.ibd')}' | true &&

        ls -a '$outfile_a.files_path' &&
        
        mkdir $outfile_b.files_path &&
        mv ./outdata_B.imzML '${os.path.join($outfile_b.files_path, 'outfile_B.imzml')}' | true &&
        mv ./outdata_B.ibd '${os.path.join($outfile_b.files_path, 'outfile_B.ibd')}' | true &&

        echo 'imzML A:' > $outfile_a &&
        ls -l '$outfile_a.files_path' >> $outfile_a &&

        echo 'imzML B:' > $outfile_b &&
        ls -l '$outfile_b.files_path' >> $outfile_b

        ## currently, only the first two files are returned, as the dynamic collecting fails
            
        ]]></command>    
       <inputs>
            <param name='infile' type='data' format='imzml' label='MSI data' help='Load the .imzml file on which the QC should be performed'/>
                
            <param name='tsv_annotation' label='ROI annotation as tsv file' type='data' format='tsv'
                       help='Load a .tsv file for ROI annoation. \n
                       This file needs three columns with "x", "y" and "annotation".
                       Please use the origin (0|0) to refence the pixel coordinates.'/>
    
        </inputs>
    
        <outputs>
            <collection name='outputs_collect' type='list' label='${tool.name} on ${on_string}: ROI imzML files'>
                <discover_datasets pattern='(?P&lt;designation&gt;.+)\.imzml' directory='$outfile_a.files_path' visible='false'/>
            </collection> 
            <!-- I dont get why this does not find anything. the export is perfectly capable of finding the file (when hardcoded)
             But the collection fails to find it. Why? (⊙＿⊙') 
              (;´༎ຶД༎ຶ`)-->
            <data format='imzml' name='outfile_a' label='ROI A imzML, Conversion result of ${on_string}: imzML'/>
            <data format='imzml' name='outfile_b' label='ROI B imzML, Conversion result of ${on_string}: imzML'/>
        </outputs>
    
    <help><![CDATA[
    @I2NCA_DESCRIPTION@
    
    This tool creates imzML files from one input file to create different subseselections as imzml files.
    Input a ROI annotation to obtain one imzml file per annotated ROI.
    

    **Input data**
    

    @MSIDATA_INPUT_DESCRIPTION@
    

    ROI annotation: Please provide a list of ROI annotations as tsv file:
        - The file needs three columns with 'x', 'y' and 'annotation' headers.
        - The x and y annotations should be aligned so that the full file has the origin (0|0).
        - All rows with the same string as 'annotation' are grouped to one ROI.
        ]]></help>
    <citations>
        <citation type='bibtex'>
            @misc{githubi2nca,
            author = {Jannik Witte},
            title = {i2nca},
            publisher = {GitHub},
            journal = {Github repository},
            url = {https://github.com/cKNUSPeR/i2nca}
        }
        </citation>
        <citation type='bibtex'>
            @article{10.1093/gigascience/giab049,
                author = {Cordes, Jonas and Enzlein, Thomas and Marsching, Christian and Hinze, Marven and Engelhardt, Sandy and Hopf, Carsten and Wolf, Ivo},
                title = '{M2aia—Interactive, fast, and memory-efficient analysis of 2D and 3D multi-modal mass spectrometry imaging data}',
                journal = {GigaScience},
                volume = {10},
                number = {7},
                year = {2021},
                month = {07},
                issn = {2047-217X},
                doi = {10.1093/gigascience/giab049},
                url = {https://doi.org/10.1093/gigascience/giab049}
            }
        </citation>
    </citations>
    </tool>
    