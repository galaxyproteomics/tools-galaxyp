<tool id='i2nca_joiner' name='Join different imzML files together with i2nca' version='@TOOL_VERSION@+galaxy@GALAXY_VERSION@'>
    <description>
        Combine two or more .imzML files together to one file.
        Geometry and location of all files can be controlled.
        It is recommended to perform a normalization before joining.
        The resulting file will be a processed file.
    </description>
    <macros>
        <import>macros.xml</import>
    </macros>
    <requirements>
        <container type='docker'>@BIOCONTAINER_VERSION@</container>
    </requirements>
    <command detect_errors='exit_code'><![CDATA[
    #set $indata_str = ''
    #set $counter = 1

    #for $file in $infiles

        cp '${file.extra_files_path}/imzml' 'indata_${counter}.imzML' &&
        cp '${file.extra_files_path}/ibd' 'indata_${counter}.ibd' &&

        #set $indata_str = $indata_str+''indata_'+str($counter)+'.imzML' '
        #set $counter = $counter + 1
    #end for

    #set $indata_str = $indata_str[:-1]

    #if $OV_polarity.rewrite_polatiry == 'No':
        'i2nca_file_joiner' './outdata' --nor '$normalization' --pad '$padding' --col '$nr_cols' $indata_str &&
    #else if $OV_polarity.rewrite_polatiry == 'Yes':
        'i2nca_file_joiner' './outdata' --nor '$normalization' --pad '$padding' --col '$nr_cols' --pol '$OV_polarity.polarity' $indata_str &&       
    #end if

    
    mkdir $outfile_imzml.files_path &&


    mv ./outdata_combined.imzML '${os.path.join($outfile_imzml.files_path, 'imzml')}' | true &&
    mv ./outdata_combined.ibd '${os.path.join($outfile_imzml.files_path, 'ibd')}' | true &&

    echo 'imzML file:' > $outfile_imzml &&
    ls -l '$outfile_imzml.files_path' >> $outfile_imzml

    ]]></command>
    <inputs>
        <param name='infiles' type='data' format='imzml' multiple='true' label='MSI data' help='Load the .imzml file on which the QC should be performed'/>
        <param name='normalization' label='Should a normalization method be used before joining?' type='select'>
            <option value='None'>None</option>
            <option value='RMS'>RMS Normalization</option>
            <option value='TIC'>TIC Normalization</option>
        </param>
        <param name='nr_cols' label='Number of columns' type='integer' value='2' help='Define in how many columns the joined files should be arranged.         The resulting rows are filled left to right.'/>
        <param name='padding' label='Distance between joined files in pixels' type='integer' value='10' help='Define how many empty pixels are spaced between two neighbouring files'/>
        <conditional name='OV_polarity'>
            <param name='rewrite_polatiry' label='Do you want to overwrite the polarity?                                                   Combined files can only be of one polarity.' type='select'>
                <option value='No'>No</option>
                <option value='Yes'>Yes</option>
            </param>
            <when value='Yes'>
                <param name='polarity' label='Overwrite polarity to:' type='select' help='Choose a polarity to overwrite. The old polariy will not be retained.'>
                    <option value='Positive'>Positive Mode</option>
                    <option value='Negative'>Negative Mode</option>
                </param>
            </when>
            <when value='No'>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data format='imzml' name='outfile_imzml' label='Joined imzML, from ${on_string}: imzML'/>
        <data name='JoinedTableFile' label='Positions in joined file, from ${on_string}' from_work_dir='./outdata_pixel_transform_matrix.tsv' format='tsv'/>
    </outputs>
    <tests>
        <test expect_num_outputs='2'>
            <param name='infiles'>
                <collection type='list'>
                    <element name='infile' value='' ftype='imzml'>
                        <composite_data value='cc.imzML'/>
                        <composite_data value='cc.ibd'/>
                    </element>
                    <element name='infile' value='' ftype='imzml'>
                        <composite_data value='pc.imzML'/>
                        <composite_data value='pc.ibd'/>
                    </element>
                </collection>
            </param>
            <param name='normalization' value='RMS'/>
            <param name='nr_cols' value='2'/>
            <param name='padding' value='10'/>
            <conditional name='OV_polarity'>
                <param name='rewrite_polatiry' value='No'/>
            </conditional>
            <output name='outfile_imzml' ftype='imzml'>
                <extra_files type='file' file='jpc_test1.imzml' name='imzml' lines_diff='6'/>
                <extra_files type='file' file='jpc_test1.ibd' name='ibd' compare='sim_size'/>
            </output>
            <output name='JoinedTableFile' file='jpc_test1_annotation.tsv' lines_diff='0'/>
        </test>
    </tests>
    <help><![CDATA[
        @I2NCA_DESCRIPTION@
    
        This tool joins different imzML files together to obtain one Processed imzml file.
        
    
        **Input data**
        
    
        @MSIDATA_INPUT_DESCRIPTION@
        
    
        Normalization: Before the files are joined together, each file can be normalized so that the intra-file variance can be reduced. Different Normalization strategies can be applied.

        Number of Columns: This parameter controls how the files are aranged. All columns are filled left to right, by defining the columns, the geometry of the output file is controlled.

        Pixel distance: This parameters controls how far each file is placed from each other (both in x and y dimension). The files themself can have different dimensions. A bounding box is used that is equal to the lagest file and to this box boundaries, the padding is added.

        Overwrite polarity: Some imzml files have not completely coherent metadata annotation. If this is the case, the metadata for the polarity can be overwritten. A file can only have one polarity, so this value is set for the created file.

    
        ]]></help>
    <citations>
        <expand macro='citation_i2nca'/>
        <expand macro='citation_m2aia'/>
    </citations>
</tool>
