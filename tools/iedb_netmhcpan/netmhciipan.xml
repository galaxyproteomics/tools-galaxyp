<tool id="iedb_netmhciipan" name="NetMHCiiPan" version="4.1+galaxy1" profile="25.1">
    <description>MHCii Binding prediction</description>
    <macros>
        <import>netmhciipan_alleles_macros.xml</import>
        <import>shared_macros.xml</import>
    </macros>
    <expand macro="requirements" />
    <expand macro="required_files"/>

    <command detect_errors="exit_code"><![CDATA[
        #import re

        python '${__tool_directory__}/nextgen_iedb_api.py'
        --tool-group=mhcii
        #for $method in $methods:
          --method=$method
        #end for

        #if $alleles.allelesrc == 'history':
          -A '$alleles.allele_file'
        #else:
          -A '$entered_alleles'
        #end if
        #if $inversion == 'true'
          -R
        #end if
        #if $split_conditional.input_peptide_length == 'split'
          -l $split_conditional.length_start,$split_conditional.length_end
        #end if
        -P '$peptide_shift'

        #if $sequence.seqsrc == 'fasta':
          -i '$sequence.seq_fasta'
        #else if $sequence.seqsrc == 'tabular':
          -i '$sequence.seq_tsv'
          -c #echo int(str($sequence.pep_col)) - 1
        #else:
          -i '$entered_seqs' -c 0
        #end if

        -o '$output'
    ]]></command>
    <configfiles>
        <expand macro="configfiles" />
    </configfiles>
    <inputs>
        <param name="methods" type="select" multiple="true" label="prediction method">
            <option value="netmhciipan_el" selected="true">netmhciipan_el</option>
            <option value="netmhciipan_ba">netmhciipan_ba</option>
        </param>
        <expand macro="inputs" hla_examples="DPA1*01/DPB1*04:01 HLA-DRB1*01:01 H2-IAb"/>
        <param name="peptide_shift" type="integer" value="5" label="Peptide shift"/>
        <param name="inversion" type="boolean" truevalue="true" falsevalue="false" checked="false" label="Add reversed peptides to input database"/>
    </inputs>
    <outputs>
        <data name="output" format="tabular" label="IEDB NetMHCiiPan ${methods}"/>
    </outputs>
    <tests>
        <!-- test1 -->
        <test expect_num_outputs="1">
            <param name="alleles|allelesrc" value="entry"/>
            <param name="alleles|allele_text" value="HLA-DQA1*03:01/DQB1*06:02 HLA-DQA1*03:01/DQB1*06:04"/>
            <param name="methods" value="netmhciipan_ba,netmhciipan_el"/>
            <param name="split_conditional|input_peptide_length" value="split"/>
            <param name="split_conditional|length_start" value="13"/>
            <param name="split_conditional|length_end" value="17"/>
            <param name="sequence|seqsrc" value="entry"/>
            <param name="sequence|seq_text" value="SLYNTVATLYCVHQRIDV"/>
            <param name="inversion" value="true"/>
            <output name="output" file="outputs/netmhciipan_output_1.tsv"/>
        </test>
        <!-- test2 -->
        <test expect_num_outputs="1">
            <param name="alleles|allelesrc" value="history"/>
            <param name="alleles|allele_file" value="netmhciipan_alleles.txt"/>
            <param name="split_conditional|input_peptide_length" value="split"/>
            <param name="split_conditional|length_start" value="13"/>
            <param name="split_conditional|length_end" value="17"/>
            <param name="sequence|seqsrc" value="tabular"/>
            <param name="sequence|seq_tsv" value="seqs.tsv"/>
            <param name="sequence|pep_col" value="3"/>
            <param name="inversion" value="true"/>
            <output name="output" file="outputs/netmhciipan_output_2.tsv"/>
        </test>
        <!-- test3 -->
        <test expect_num_outputs="1">
            <param name="alleles|allelesrc" value="history"/>
            <param name="alleles|allele_file" value="netmhciipan_alleles.txt"/>
            <param name="split_conditional|input_peptide_length" value="as_is"/>
            <param name="peptide_shift" value="6"/>
            <param name="sequence|seqsrc" value="fasta"/>
            <param name="sequence|seq_fasta" value="seqs.fa"/>
            <param name="inversion" value="true"/>
            <output name="output" file="outputs/netmhciipan_output_3.tsv"/>
        </test>
    </tests>
    <help><![CDATA[
The NetMHCiipan-4.1 server predicts binding of peptides to any MHC II molecule of known sequence using artificial neural networks (ANNs).

This tool uses the "Next-Generation IEDB Tools" API to submit NetMHCiipan-4.1 jobs and retrieve results.
IEDB is a free resource, funded by a contract from the National Institute of Allergy and Infectious Diseases.
    ]]></help>
    <citations>
        <expand macro="citations" />
    </citations>
</tool>
