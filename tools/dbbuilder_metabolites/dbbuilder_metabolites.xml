<tool id="dbbuilder_metabolites" name="Metabolite Database Downloader" version="0.1.0">
    <description>
        A tool to download free metabolite spectral databases.
    </description>
    <requirements>
        <requirement type="package" version="1.18">gnu-wget</requirement>
    </requirements>
    <stdio>
        <exit_code range="1:"  level="fatal" description="Error downloading database." />
        <regex match="ERROR" level="fatal" source="stderr" description="Error downloading database." />
        <!-- TODO: escape quotes. -->
    </stdio>
    <command><![CDATA[
    #if $db.source == "mona"
        #set $type = "zip"
        #if $db.chooseformat.format == "msp"
            #if $db.chooseformat.subset.restrictto == "complete"
                #set $url = "http://mona.fiehnlab.ucdavis.edu/rest/downloads/retrieve/bac65837-f63a-4aa9-96e7-35b5484040f6"
            #else
                #set $url = "http://mona.fiehnlab.ucdavis.edu/rest/downloads/retrieve/" + str($db.chooseformat.subset.id)
            #end if
        #elif $db.chooseformat.format == "json"
            #if $db.chooseformat.subset.restrictto == "complete"
                #set $url = "http://mona.fiehnlab.ucdavis.edu/rest/downloads/retrieve/95dfddc4-53c9-48b9-8a0a-2b2301643649"
            #else
                #set $url = "http://mona.fiehnlab.ucdavis.edu/rest/downloads/retrieve/" + str($db.chooseformat.subset.id)
            #end if
        #end if
    #elif $db.source == "hmdb"
        #set $url = "http://www.hmdb.ca/system/downloads/current/" + str($db.fluid) + "_metabolites.zip"
        #set $type = "zip"
    #elif $db.source == "url"
        #set $url = $db.url
        #set $type = $db.archive_type
    #end if
    #if $type =="direct"
        wget -nv '$url' -O '${output_database}'
    #elif $type =="zip"
        wget -nv '$url' -O tmp.zip --no-check-certificate && zcat -c tmp.zip > '${output_database}'
    #elif $type =="gzip"
        wget -nv '$url' -O tmp.gz --no-check-certificate && (if `command -v gzcat > /dev/null`;  then gzcat tmp.gz; else zcat tmp.gz ; fi) > '${output_database}'
    #elif $type =="bzip2"
        wget -nv '$url' -O tmp.bz2 --no-check-certificate && bzcat tmp.bz2 > '${output_database}'
    #elif $type =="tgz"
        wget -nv '$url' -O tmp.tar.gz && tar zxfO tmp.tar.gz > '${output_database}'
    #elif $type =="tbz"
        wget -nv '$url' -O tmp.tar.bz && tar jxfO tmp.tar.bz > '${output_database}'
    #end if
  ]]></command>
    <inputs>
        <conditional name="db">
            <param name="source" type="select" label="Database" help="Select database.">
                <option value="mona">MassBank of Northern America (MoNA)</option>
                <option value="hmdb">Human Metabolite Database (HMDB)</option>
                <!-- ToDo: Many more databases could be integrated, see: http://metabolomicssociety.org/resources/metabolomics-databases -->
                <option value="url">Custom URL</option>
            </param>
            <when value="mona">
                <conditional name="chooseformat">
                    <param name="format" type="select" label="Select data format" help="MoNA provides all data in either MSP (spectra only, compatible to &quot;NIST MS Search&quot; software) or JSON (spectra with metadata) format.">
                        <option value="msp">MSP format (*.msp)</option>
                        <option value="json">JSON format (*.json)</option>
                    </param>
                    <when value="msp">
                        <conditional name="subset">
                            <param name="restrictto" type="select" label="Restrict spectra to subset" help="Download the full MoNA spectra database or restrict the spectra to a subset of your choice.">
                                <option value="complete">Complete database</option>
                                <option value="library">Single external library</option>
                                <option value="method">Single MS method (GC-MS or LC-MS)</option>
                            </param>
                            <when value="complete" />
                            <when value="library">
                                <param name="id" type="select" label="Choose library" help="Subset MoNA spectra database to those spectra originating from another spectra library. This is usually not equal to the full original library.">
                                    <options from_file="mona_libraries_msp.loc">
                                        <column name="name" index="0" />
                                        <column name="value" index="1" />
                                    </options>
                                </param>  
                            </when>
                            <when value="method">
                                <param name="id" type="select" label="Choose method" help="Subset MoNA spectra database to those spectra originating from the selected type of chromatography.">
                                    <options from_file="mona_methods_msp.loc">
                                        <column name="name" index="0" />
                                        <column name="value" index="1" />
                                    </options>
                                </param>
                            </when>
                        </conditional>
                    </when>
                    <when value="json">
                        <conditional name="subset">
                            <param name="restrictto" type="select" label="Restrict spectra to subset" help="Download the full MoNA spectra database or restrict the spectra to a subset of your choice.">
                                <option value="complete">Complete database</option>
                                <option value="library">Single external library</option>
                                <option value="method">Single MS method (GC-MS or LC-MS)</option>
                            </param>
                            <when value="complete" />
                            <when value="library">
                                <param name="id" type="select" label="Choose library" help="Subset MoNA spectra database to those spectra originating from another spectra library. This is usually not equal to the full original library.">
                                    <options from_file="mona_libraries_json.loc">
                                        <column name="name" index="0" />
                                        <column name="value" index="1" />
                                    </options>
                                </param>  
                            </when>
                            <when value="method">
                                <param name="id" type="select" label="Choose method" help="Subset MoNA spectra database to those spectra originating from the selected type of chromatography.">
                                    <options from_file="mona_methods_json.loc">
                                        <column name="name" index="0" />
                                        <column name="value" index="1" />
                                    </options>
                                </param>
                            </when>
                        </conditional>
                    </when>
                </conditional>
            </when>
            <when value="hmdb">
                <param name="fluid" type="select" label="Type" help="Select type of database. HMDB sorts metabolites by the human body fluids they were detected in.">
                    <options from_file="hmdb_types.loc">
                        <column name="name" index="0" />
                        <column name="value" index="1" />
                    </options>
                </param>
            </when>
            <when value="url">
                <param name="url" value="" type="text" label="URL (http, ftp) of metabolite database">
                    <sanitizer>
                        <valid>
                            <add value="%"/>
                            <add value="~"/>
                        </valid>
                    </sanitizer>
                </param>
                <param name="archive_type" type="select" label="Metabolite database source compression type">
                    <option value="direct" selected="true">uncompressed database</option>
                    <option value="zip">zip compressed (*.zip), e.g. for MoNA and HMDB</option>
                    <option value="gzip">gzip compressed (*.gz)</option>
                    <option value="bzip2">bzip2 compressed (*.bz2)</option>
                    <option value="tgz">tar archive gzip compressed (*.tgz or *.tar.gz)</option>
                    <option value="tbz">tar archive bzip2 compressed (*.tbz or *.tar.bz)</option>
                </param>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data auto_format="true" name="output_database" label="Metabolite Database">
            <change_format>
                <when input="db.chooseformat.format" value="msp" format="msp" />
                <when input="db.chooseformat.format" value="json" format="json" />
                <when input="db.source" value="hmdb" format="xml" />
            </change_format>
        </data>
    </outputs>
    <tests>
        <test>
            <param name="db|source" value="mona" />
            <param name="db|chooseformat|format" value="msp" />
            <param name="db|chooseformat|subset" value="library" />
            <param name="db|chooseformat|subset|id" value="8e7a9605-728e-4758-b090-477ff1e5be73" />
            <output name="output_database">
                <assert_contents>
                    <has_text text="1,2,3-Triazole" />
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="db|source" value="hmdb" />
            <param name="db|fluid" value="csf" />
            <output name="output_database">
                <assert_contents>
                    <has_line line="&lt;hmdb xmlns=&quot;http://www.hmdb.ca&quot;&gt;" />
                    <has_line line="  &lt;accession&gt;HMDB0000001&lt;/accession&gt;" />
                </assert_contents>
            </output>
        </test>
        <test>
            <param name="source" value="url" />
            <param name="url" value="http://www.massbank.jp/SVN/OpenData/record/CASMI_2016/SM800003.txt" />
            <param name="archive_type" value="direct" />
            <output name="output_database">
                <assert_contents>
                    <has_text text="1,2,3-Triazole" />
                </assert_contents>
            </output>
        </test>
    </tests>
    <help>
<![CDATA[
**Comments**

The tool currently covers GC-MS databases only. No common file format has been established for metabolomics databases so far, therefore you have to consider:
  
- **Caution 1:** Databases are sometimes provided by different online sources in different formats. The databases might not contain the same data, if downloaded in another format. An example would be the Human Metabolome Database (HMDB), which natively uses XML format. It can also be accessed online using the MassBank of Northern America (MoNA), which uses MSP or JSON format. MSP format reduces the data to (named) spectra only, all other metadata (e.g. KEGG links) present in the native XML format are not reflected. JSON format keeps metadata.

- **Caution 2:**  "MSP" or "MSL" format is not always the same. Many databases use a slightly different way to write "MSP" format. The different formats usually contain the same type of information, but use a unique file structure. Thus, not all "MSP" formats are directly compatible.

**Databases included**

**MoNA:** MassBank of Northern America (MoNA) collects spectra from many other free databases (e.g. HMDB, RTX Fiehnlib, LipidBlast) and combines them into one huge library. You can restrict the spectra either based on the method (e.g. GC-MS) or based on the source (e.g. HMDB). 
*Format:* MSP (spectra only; NIST-compatible) or JSON (spectra with metadata)

**HMDB:** Human Metabolome Database (HMDB) is a freely available electronic database containing detailed information about small molecule metabolites found in the human body. Sorted by human body fluids (e.g. serum, saliva). Contains metadata.
*Format:* XML

**Output**

Creates a database file of the requested database in the requested format.

**External links**

The Metabolomics Society provides an overview on different free databases: http://metabolomicssociety.org/resources/metabolomics-databases
]]>
    </help>
</tool>
