<tool id="proteomiqon_mzmltomzlite" name="ProteomIQon MzMLToMzLite" version="0.0.5" python_template_version="3.5">
    <requirements>
        <requirement type="package" version="0.0.5">proteomiqon-mzmltomzlite</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        #import re
        #set basename = $re.sub(r'[^\w ,.\-+]','_',$instrumentOutput.element_identifier)
        ln -s $instrumentOutput '${basename}.mzML';
        ln -s $out_mzlite '${basename}.mzlite';
        proteomiqon-mzmltomzlite -i "./${basename}.mzML" -p $paramfile -o ./;
    ]]>
    </command>
    <configfiles>
        <configfile name="paramfile">
            {
                "Compress":${BinaryDataCompressionType},
#if $StartRetentionTimeCond.useStartRetentionTime
                "StartRetentionTime":${StartRetentionTimeCond.StartRetentionTime},
#else
                "StartRetentionTime":null,
#end if
#if $EndRetentionTimeCond.useEndRetentionTime
                "EndRetentionTime":${EndRetentionTimeCond.EndRetentionTime},
#else
                "EndRetentionTime":null,
#end if
                "MS1PeakPicking": {
                    "Case": "${Ms1PeakPickingCond.Ms1PeakPicking}",
#if $Ms1PeakPickingCond.Ms1PeakPicking == "Centroid"
                    "Fields" : 
                    [ 
                        {
                            "Case" : "${Ms1PeakPickingCond.CentroidModeCond.CentroidMode}",
                            #if $Ms1PeakPickingCond.CentroidModeCond.CentroidMode == "Wavelet"
                            "Fields" : 
                            [
                                {
                                    "NumberOfScales" : ${Ms1PeakPickingCond.CentroidModeCond.NumberOfScales},
                                    "YThreshold" : 
                                    {
                                        "Case" : "${Ms1PeakPickingCond.CentroidModeCond.YThresholdCond.YThreshold}",
                                        #if $Ms1PeakPickingCond.CentroidModeCond.YThresholdCond.YThreshold == "Fixed"
                                        "Fields": 
                                        [
                                            ${Ms1PeakPickingCond.CentroidModeCond.YThresholdCond.Ms1YThreshold},
                                        ]
                                        #end if 
                                    },
                                    "Centroid_MzTolerance" : ${Ms1PeakPickingCond.CentroidModeCond.Centroid_MzTolerance},
                                    "SNRS_Percentile" : ${Ms1PeakPickingCond.CentroidModeCond.SNRS_Percentile},
                                    "MinSNR" : ${Ms1PeakPickingCond.CentroidModeCond.MinSNR},
                                    "RefineMZ" : ${Ms1PeakPickingCond.CentroidModeCond.RefineMZ},
                                    "SumIntensities" : ${Ms1PeakPickingCond.CentroidModeCond.SumIntensities},
                                    #if $Ms1PeakPickingCond.CentroidModeCond.PaddingParamsCond.usePaddingparams
                                    "PaddingParams" : 
                                    {
                                        "Case" : "Some",
                                        "Fields" :
                                        [
                                            {
                                                #if $Ms1PeakPickingCond.CentroidModeCond.PaddingParamsCond.MaximumPaddingPointsCond.specifyMaximumPaddingPoints
                                                "MaximumPaddingPoints" : {
                                                    "Case" : "Some",
                                                    "Fields" : [
                                                        $Ms1PeakPickingCond.CentroidModeCond.PaddingParamsCond.MaximumPaddingPointsCond.MaximumPaddingPoints
                                                    ]
                                                },
                                                #else
                                                "MaximumPaddingPoints" : null,
                                                #end if
                                                "Padding_MzTolerance" : $Ms1PeakPickingCond.CentroidModeCond.PaddingParamsCond.Padding_MzTolerance,
                                                "WindowSize" : $Ms1PeakPickingCond.CentroidModeCond.PaddingParamsCond.WindowSize,
                                                "SpacingPerc" : $Ms1PeakPickingCond.CentroidModeCond.PaddingParamsCond.SpacingPerc
                                            }
                                        ]

                                    }
                                    #else
                                    "PaddingParams" : null
                                    #end if
                                }
                               
                            ]
                            #end if
                        }
                    ]
#end if
                },
                "MS2PeakPicking": {
                    "Case": "${Ms2PeakPickingCond.Ms2PeakPicking}",
#if $Ms2PeakPickingCond.Ms2PeakPicking == "Centroid"
                    "Fields" : 
                    [ 
                        {
                            "Case" : "${Ms2PeakPickingCond.CentroidModeCond.CentroidMode}",
                            #if $Ms2PeakPickingCond.CentroidModeCond.CentroidMode == "Wavelet"
                            "Fields" : 
                            [
                                {
                                    "NumberOfScales" : ${Ms2PeakPickingCond.CentroidModeCond.NumberOfScales},
                                    "YThreshold" : 
                                    {
                                        "Case" : "${Ms2PeakPickingCond.CentroidModeCond.YThresholdCond.YThreshold}",
                                        #if $Ms2PeakPickingCond.CentroidModeCond.YThresholdCond.YThreshold == "Fixed"
                                        "Fields": 
                                        [
                                            ${Ms2PeakPickingCond.CentroidModeCond.YThresholdCond.Ms2YThreshold},
                                        ]
                                        #end if 
                                    },
                                    "Centroid_MzTolerance" : ${Ms2PeakPickingCond.CentroidModeCond.Centroid_MzTolerance},
                                    "SNRS_Percentile" : ${Ms2PeakPickingCond.CentroidModeCond.SNRS_Percentile},
                                    "MinSNR" : ${Ms2PeakPickingCond.CentroidModeCond.MinSNR},
                                    "RefineMZ" : ${Ms2PeakPickingCond.CentroidModeCond.RefineMZ},
                                    "SumIntensities" : ${Ms2PeakPickingCond.CentroidModeCond.SumIntensities},
                                    #if $Ms2PeakPickingCond.CentroidModeCond.PaddingParamsCond.usePaddingparams
                                    "PaddingParams" : 
                                    {
                                        "Case" : "Some",
                                        "Fields" :
                                        [
                                            {
                                                #if $Ms2PeakPickingCond.CentroidModeCond.PaddingParamsCond.MaximumPaddingPointsCond.specifyMaximumPaddingPoints
                                                "MaximumPaddingPoints" : {
                                                    "Case" : "Some",
                                                    "Fields" : [
                                                        $Ms2PeakPickingCond.CentroidModeCond.PaddingParamsCond.MaximumPaddingPointsCond.MaximumPaddingPoints
                                                    ]
                                                },
                                                #else
                                                "MaximumPaddingPoints" : null,
                                                #end if
                                                "Padding_MzTolerance" : $Ms2PeakPickingCond.CentroidModeCond.PaddingParamsCond.Padding_MzTolerance,
                                                "WindowSize" : $Ms2PeakPickingCond.CentroidModeCond.PaddingParamsCond.WindowSize,
                                                "SpacingPerc" : $Ms2PeakPickingCond.CentroidModeCond.PaddingParamsCond.SpacingPerc
                                            }
                                        ]

                                    }
                                    #else
                                    "PaddingParams" : null
                                    #end if
                                }
                               
                            ]
                            #end if
                        }
                    ]
#end if
                }
            }
        </configfile>
    </configfiles>
    <inputs>
        <param type="data" name="instrumentOutput" format="mzml" label="Instrument output" help="Please specify the .mzML file you want to convert"/>
        <param name="BinaryDataCompressionType" type="select" label="Binary data compression type">
            <option value="0" selected="true">No compression</option>
            <option value="1">ZLib</option>
            <option value="2">Num press</option>
            <option value="3">Num press ZLib</option>
            <option value="4">Num press Pic</option>
            <option value="5">Num press Lin</option>
        </param>
        <conditional name="StartRetentionTimeCond">
            <param type="boolean" name="useStartRetentionTime" label="Use start retention time" checked="false" help="You can optionally specify a minimum scan time. MS scans measured earlier will not be copied."/>
            <when value="true">
                <param type="float" name="StartRetentionTime" label="Start retention time" value="0"/>
            </when>
        </conditional>
        <conditional name="EndRetentionTimeCond">
            <param type="boolean" name="useEndRetentionTime" label="Use end retention time" checked="false" help="You can optionally specify a maximum scan time. MS scans measured at a later scan time will not be copied."/>
            <when value="true">
                <param type="float" name="EndRetentionTime" label="Start retention time" value="0"/>
            </when>
        </conditional>
        <conditional name="Ms1PeakPickingCond">
            <param name="Ms1PeakPicking" type="select" label="MS1 peak picking">
                <option value="ProfilePeaks" selected="true">Profile peaks</option>
                <option value="Centroid">Centroid</option>
            </param>
            <when value="Centroid">
                <conditional name="CentroidModeCond">
                    <param name="CentroidMode" type="select" label="Centroidization mode">
                        <option value="Manufacturer">Manufacturer</option>
                        <option value="Wavelet">Wavelet</option>
                    </param>
                    <when value="Wavelet">
                        <param type="integer" name="NumberOfScales" label="Number of scales" value="0"/>
                        <conditional name="YThresholdCond">
                            <param name="YThreshold" type="select" label="Y threshold">
                                <option value="Fixed" selected="true">Fixed</option>
                                <option value="MinSpectrumIntensity">Min spectrum intensity</option>
                            </param>
                            <when value="Fixed">
                                <param type="float" name="Ms1YThreshold" label="Value" value="0"/>
                            </when>
                        </conditional>
                        <param type="float" name="Centroid_MzTolerance" label="Centroid MZ tolerance" value="0"/>
                        <param type="float" name="SNRS_Percentile" label="SNRS percentile" value="0"/>
                        <param type="float" name="MinSNR" label="Min SNR" value="0"/>
                        <param type="boolean" name="RefineMZ" label="Refine MZ" value="false"/>
                        <param type="boolean" name="SumIntensities" label="Sum intensities" value="false"/>
                        <conditional name="PaddingParamsCond">
                            <param type="boolean" name="usePaddingparams" label="Padding" checked="false"/>           
                            <when value="true">
                                <conditional name="MaximumPaddingPointsCond">
                                    <param type="boolean" name="specifyMaximumPaddingPoints" label="Speficy maximum padding points" checked="true"/>
                                    <when value="true">
                                        <param type="integer" name="MaximumPaddingPoints" label="Maximum padding points" value="0"/>
                                    </when>        
                                </conditional>
                                <param type="float" name="Padding_MzTolerance" label="Padding MZ tolerance" value="0"/>
                                <param type="integer" name="WindowSize" label="Window size" value="0"/>
                                <param type="float" name="SpacingPerc" label="Spacing perc" value="0"/>
                            </when>
                        </conditional>
                    </when>
                </conditional>
            </when>
        </conditional>
        <conditional name="Ms2PeakPickingCond">
            <param name="Ms2PeakPicking" type="select" label="MS2 peak picking">
                <option value="ProfilePeaks" selected="true">Profile peaks</option>
                <option value="Centroid">Centroid</option>
            </param>
            <when value="Centroid">
                <conditional name="CentroidModeCond">
                    <param name="CentroidMode" type="select" label="Centroidization mode">
                        <option value="Manufacturer">Manufacturer</option>
                        <option value="Wavelet">Wavelet</option>
                    </param>
                    <when value="Wavelet">
                        <param type="integer" name="NumberOfScales" label="Number of scales" value="0"/>
                        <conditional name="YThresholdCond">
                            <param name="YThreshold" type="select" label="Y threshold">
                                <option value="Fixed" selected="true">Fixed</option>
                                <option value="MinSpectrumIntensity">Min spectrum intensity</option>
                            </param>
                            <when value="Fixed">
                                <param type="float" name="Ms2YThreshold" label="Value" value="0"/>
                            </when>
                        </conditional>
                        <param type="float" name="Centroid_MzTolerance" label="Centroid MZ tolerance" value="0"/>
                        <param type="float" name="SNRS_Percentile" label="SNRS percentile" value="0"/>
                        <param type="float" name="MinSNR" label="Min SNR" value="0"/>
                        <param type="boolean" name="RefineMZ" label="Refine MZ" value="false"/>
                        <param type="boolean" name="SumIntensities" label="Sum intensities" value="false"/>
                        <conditional name="PaddingParamsCond">
                            <param type="boolean" name="usePaddingparams" label="Padding" checked="false"/>           
                            <when value="true">
                                <conditional name="MaximumPaddingPointsCond">
                                    <param type="boolean" name="specifyMaximumPaddingPoints" label="Speficy maximum padding points" checked="true"/>
                                    <when value="true">
                                        <param type="integer" name="MaximumPaddingPoints" label="Maximum padding points" value="0"/>
                                    </when>        
                                </conditional>
                                <param type="float" name="Padding_MzTolerance" label="Padding MZ tolerance" value="0"/>
                                <param type="integer" name="WindowSize" label="Window size" value="0"/>
                                <param type="float" name="SpacingPerc" label="Spacing perc" value="0"/>
                            </when>
                        </conditional>
                    </when>
                </conditional>
            </when>
        </conditional>
    </inputs>
    <outputs>
        <data format="sqlite" name="out_mzlite" />
    </outputs>
    <help>
    <![CDATA[
Introduction
------------
The success of modern proteomics was made possible by constant progression in the field of mass spectrometry. 
Over the course of the past years quite a few manufacturers of mass spectrometers have managed to establish themselfes in the field of biological research. 
Since aquisition and accession of mass spectra are performance critical processes, various performance optimized, but vendor specific and closed source formats have been developed to store raw MS data. 
This comes to the disadvantage for toolchain developers which want to provide tools for every scientist regardless of the format of their raw data.

In a effort to provide an open format for the storage of MS data the format mzML was developed. While this XML based format is straight forward to implement it falls behind in performance critical scenarios. 
To be competitive in performance and to comply to the FAIR principles we chose to use mzLite, an open and SQLite based implementation of mzML, within our toolchain.

What It Does
------------
The tool mzMLToMzLite allows to convert mzML files to mzLite files. Additionally, it allows the user to perform peak picking or filtering of mass spectra.
We recommend the use of `_msconvert <https://usegalaxy.eu/root?tool_id=toolshed.g2.bx.psu.edu/repos/galaxyp/msconvert/msconvert/3.0.20287.2>`_ to convert your raw data into .mzML. 

Further Reading
---------------
Additional information about the tool can be found in the `_documentation <https://csbiology.github.io/ProteomIQon/tools/MzMLToMzLite.html>`_.
    ]]>
    </help>
</tool>