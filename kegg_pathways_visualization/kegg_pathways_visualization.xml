<tool id="kegg_pathways_visualization" name="KEGG pathways" version="2018.10.24">
    <description>map visualisation (PathView)</description>
    <requirements>
        <requirement type="package" version="1.18.0">bioconductor-pathview</requirement>
    </requirements>
    <command detect_errors="exit_code"><![CDATA[
        Rscript $__tool_directory__/kegg_pathways_visualization.R 
        #if $input.ids == "text"
            --id_list="$input.txt"
        #else
            --input="$input.file"
            --id_column="$input.ncol"
            --header="$input.header"  
        #end if
        #if $species.pathways.pathways_id != "pathways_file"
            --pathways_id="$species.pathways.pids" 
        #else 
            --pathways_input="$species.pathways.file"
            --header2="$species.pathways.header2"
            --pathway_col="$species.pathways.ncol2"
        #end if
        --id_type="$id_type"  
        --native_kegg="$native"
        

        #if $input.ids=="file" and $input.foldchange.fc=="true"
            --fold_change_data="$input.foldchange.fc"
            --fold_change_col="$input.foldchange.fc_col"
        #else 
            --fold_change_data="false"
        #end if

        --species=${species.ref_file} 
        --pathways_list=$__tool_directory__/${ filter( lambda x: str( x[0] ) == str( $species.ref_file ), $__app__.tool_data_tables['kegg_pathways_list_index'].get_fields() )[0][-1] } 
        --output="$text_output"

    ]]></command>
    <inputs>
        <conditional name="species">
        <param name="ref_file" type="select" label="Select species" >
            <option value="hsa">Human (hsa)</option>
            <option value="mmu">Mouse (mmu)</option>
            <option value="rno">Rat (rno)</option>
        </param>
            <when value="hsa">
                <conditional name="pathways">
                <param name="pathways_id" type="select" label="Provide your pathway(s)" help="Enter KEGG pathway name(s) or KEGG pathway id(s)">
                    <option value="pathways_names">KEGG pathway name(s)</option>
                    <option value="pathways_ids">KEGG pathway id(s)</option>
                    <option value="pathways_file">KEGG pathway id(s) from file</option>
                </param>
                <when value="pathways_names">
                    <param name="pids" type="select" label="Select pathway(s)" multiple="true" help='You can select one or several pathway(s), you can write the beginning of your pathways to search using autocomplete'>
                        <options from_data_table="hsa_pathways">
                            <filter type="sort_by" column="1"/>
                            <validator type="no_options" message="No indexes are available for the selected input dataset"/>
                        </options>
                    </param>
                </when>
                <when value="pathways_ids">
                    <param name="pids" type="text" label="Copy/paste your pathway id(s)" help='IDs must be separated by "," into the form field, for example: "00010,05412" or "hsa00010,hsa05412" or "path:hsa00010"'>
                        <sanitizer invalid_char=''>
                        <valid initial="string.printable">
                            <remove value="&apos;"/>
                        </valid>
                        <mapping>
                            <add source="&#x20;" target=""/> 
                        </mapping>
                        </sanitizer>
                    </param>
                </when>
                <when value="pathways_file">
                    <param name="file" type="data" format="txt,tabular" label="Select a file with a column of pathways id" help="Pathway id format : 'path:hsa00010' or 'hsa00010' or '00010'" />
                    <param name="header2" type="boolean" checked="true" truevalue="true" falsevalue="false" label="Does your input file contains a header?" />
                    <param name="ncol2" type="text" value="c1" label="The column which contains your pathways ids" help='For example, fill in "c1" if it is the first column, "c2" if it is the second column and so on' />
                </when>
                </conditional>
            </when>
            <when value="mmu">
                <conditional name="pathways">
                <param name="pathways_id" type="select" label="Provide your pathway(s)" help="Enter KEGG pathway name(s) or KEGG pathway id(s)">
                    <option value="pathways_names">KEGG pathway name(s)</option>
                    <option value="pathways_ids">KEGG pathway id(s)</option>
                    <option value="pathways_file">KEGG pathway id(s) from file</option>
                </param>
                <when value="pathways_names">
                    <param name="pids" type="select" label="Select pathway(s)" multiple="true" help='You can select one or several pathway(s), you can write the beginning of your pathways to search using autocomplete'>
                        <options from_data_table="mmu_pathways">
                            <filter type="sort_by" column="1"/>
                            <validator type="no_options" message="No indexes are available for the selected input dataset"/>
                        </options>
                    </param>
                </when>
                <when value="pathways_ids">
                    <param name="pids" type="text" label="Copy/paste your pathway id(s)" help='IDs must be separated by "," into the form field, for example: "path:mmu00053" or "mmu00053,mmu00340" or "00053"'>
                        <sanitizer invalid_char=''>
                        <valid initial="string.printable">
                            <remove value="&apos;"/>
                        </valid>
                        <mapping>
                            <add source="&#x20;" target=""/> 
                        </mapping>
                        </sanitizer>
                    </param>
                </when>
                <when value="pathways_file">
                    <param name="file" type="data" format="txt,tabular" label="Select a file with a column of pathways id " help="Pathway id format : 'path:mmu00053' or 'mmu00053' or '00053'" />
                    <param name="header2" type="boolean" checked="true" truevalue="true" falsevalue="false" label="Does your input file contain header?" />
                    <param name="ncol2" type="text" value="c1" label="The column which contains your pathways ids" help='For example, fill in "c1" if it is the first column, "c2" if it is the second column and so on' />
                </when>
                </conditional>
            </when>
            <when value="rno">
                <conditional name="pathways">
                <param name="pathways_id" type="select" label="Enter your pathway(s) name/id" help="Enter KEGG pathway name(s) or KEGG pathway id(s)">
                    <option value="pathways_names">KEGG pathway name(s)</option>
                    <option value="pathways_ids">KEGG pathway id(s)</option>
                    <option value="pathways_file">KEGG pathway id(s) from file</option>
                </param>
                <when value="pathways_names">
                    <param name="pids" type="select" label="Select pathway(s)" multiple="true" help='You can select one or several pathway(s), you can write the beginning of your pathways to search using autocomplete'>
                        <options from_data_table="rno_pathways">
                            <filter type="sort_by" column="1"/>
                            <validator type="no_options" message="No indexes are available for the selected input dataset"/>
                        </options>
                    </param>
                </when>
                <when value="pathways_ids">
                    <param name="pids" type="text" label="Copy/paste your pathway id(s)" help='IDs must be separated by tab,space or carriage return into the form field, for example: "00010 05412" or "hsa00010 hsa05412" or "path:hsa00010"'>
                        <sanitizer invalid_char=''>
                        <valid initial="string.printable">
                            <remove value="&apos;"/>
                        </valid>
                        <mapping>
                            <add source="&#x20;" target=""/> 
                        </mapping>
                        </sanitizer>
                    </param>
                </when>
                <when value="pathways_file">
                    <param name="file" type="data" format="txt,tabular" label="Select a file with a column of pathways id" help="Pathway id format : 'path:hsa00010' or 'hsa00010' or '00010'" />
                    <param name="header2" type="boolean" checked="true" truevalue="true" falsevalue="false" label="Does your input file contains a header?" />
                    <param name="ncol2" type="text" value="c1" label="The column which contains your pathways ids" help='For example, fill in "c1" if it is the first column, "c2" if it is the second column and so on' />
                </when>
                </conditional>
            </when>
        </conditional>
        <param name="id_type" type="select" label="Select your identifiers type :">
            <option value="uniprotID">Uniprot Accession number</option>
            <option value="geneID">Entrez gene ID</option>
            <!--option value="keggid">KEGG genes ID</option-->
        </param>
        <conditional name="input" >
            <param name="ids" type="select" label="Enter your identifiers (Uniprot AC or Entrez gene ID)" help="Copy/paste or ID list from a file (e.g. table)" >
                <option value="text">Copy/paste your identifiers</option>
                <option value="file" selected="true">Input file containing your identifiers</option>
            </param>
            <when value="text" >
                <param name="txt" type="text" label="Copy/paste your identifiers" help='IDs must be separated by tab,space or carriage return into the form field, for example: P31946 P62258' >
                    <sanitizer invalid_char=''>
                        <valid initial="string.printable">
                            <remove value="&apos;"/>
                        </valid>
                        <mapping initial="none">
                            <add source="&apos;" target="__sq__"/>
                        </mapping>
                    </sanitizer>
                </param>
            </when>
            <when value="file" >
                <param name="file" type="data" format="txt,tabular" label="Select a file that contains your list of IDs" help="" />
                <param name="header" type="boolean" checked="true" truevalue="true" falsevalue="false" label="Does your input file contains a header?" />
                <param name="ncol" type="text" value="c1" label="The column which contains your IDs to map" help='For example, fill in "c1" if it is the first column, "c2" if it is the second column and so on' />
                <conditional name="foldchange" >
                <param name="fc" type="boolean" checked="false" truevalue="true" falsevalue="false" label="Do you have fold change values to represent on the graph ?" default="false"/>
                    <when value="true">
                        <param name="fc_col" type="text" label="Please enter column(s) number of fold change data separated by ','. 3 columns max" help="For example : c1,c3,c4"/>
                    </when>
                    <when value="false"/>
                </conditional>
            </when>
        </conditional>
        <param name="native" type="select" label="Choose the output graphical format">
            <option value="true">KEGG map (.png)</option>
            <option value="false">Graphviz layout engine (.pdf)</option> 
        </param>
    </inputs>
    <outputs>
        <data name="text_output" format="tsv" label="KEGG pathways visualization text output"/>
        <collection type="list" label="KEGG pathways map from ${input.file.name}" name="graphviz_output_from_file">
            <filter>native=="false" and input["ids"] == "file"</filter>
                <discover_datasets pattern="(?P&lt;designation&gt;.+\..*)\.pdf" ext="pdf" />
        </collection>
        <collection type="list" label="KEGG pathways map from ${input.file.name}" name="kegg_graph_output_from_file">
            <filter>native=="true" and input["ids"] == "file"</filter>
                <discover_datasets pattern="(?P&lt;designation&gt;.+\..*)\.png" ext="png"/>
        </collection>
        <collection type="list" label="KEGG pathways map" name="graphviz_output_from_list">
            <filter>native=="false" and input["ids"] == "text"</filter>
                <discover_datasets pattern="(?P&lt;designation&gt;.+\..*)\.pdf" ext="pdf" />
        </collection>
        <collection type="list" label="KEGG pathways map" name="kegg_graph_output_from_list">
            <filter>native=="true" and input["ids"] == "text"</filter>
                <discover_datasets pattern="(?P&lt;designation&gt;.+\..*)\.png" ext="png" />
        </collection>
    </outputs>
    <tests>
        <test>
            <conditional name="input">
                <param name="ids" value="file"/>
                <param name="file" value="Lacombe_et_al_2017_OK.txt"/>
                <param name="header" value="true"/>
                <param name="ncol" value="c1"/>
            </conditional>
            <conditional name="pathways">
                <param name="pathways_id" value="pathways_ids"/>
                <param name="pids" value="04514,05167,00010"/>
            </conditional>
            <param name="id_type" value="uniprotID"/>
            <param name="species" value="hsa"/>
            <param name="native" value="true"/>            
            <output name="kegg_from_file" file="hsa04514.pathview.png" compare="sim_size"/>
            <output name="kegg_from_file" file="hsa05167.pathview.png" compare="sim_size"/>
            <output name="kegg_from_file" file="hsa00010.pathview.png" compare="sim_size"/>
        </test>
    </tests>
    <help><![CDATA[
This tool map a list of Uniprot Accession number or Entrez gene ID to KEGG pathway with pathview R package.

Select a species of interest. 

Select one or several pathways of interest from the dropdown menu or copy/paste KEGG pathway id(s) or import it from a file.

Select an input file containing ids in a column, set header and column number or copy/paste your ids. 

You can import 1 to 3 column(s) of expression values if you are importing ids from a file.

Select your identifier type : UniprotAC or Entrez gene ID

Select the graph format : KEGG (jpg) or graphviz (pdf)

Uniprot accession number converted to Entrez geneID or Entrez geneID are mapped to each selected pathways.

Output : One file (png or pdf) for each selected pathway. 

You can see below an example of an input file with identifiers (unirpt_AC) and fold_change values.

.. csv-table:: Simulated data
   :header: "Uniprot_AC","Protein.name","Number_of_peptides","fc_values 1","fc_values 2","fc_values 3"


   "P15924","Desmoplakin","69","0.172302292051025","-0.757435966487116","0.0411240398990759"
   "P02538","Keratin, type II cytoskeletal 6A","53","-0.988842456122076","0.654626325100182","-0.219153396366064"
   "P02768","Serum albumin","44","-0.983493243315454","0.113752002761474","-0.645886132600729"
   "P08779","Keratin, type I cytoskeletal 16","29","0.552302597284443","-0.329045605110646","2.10616106806788"
   "Q02413","Desmoglein-1","24","1.06904266431586","-0.120086393787255","0.227359496360723"
   "P07355","Annexin A2;Putative annexin A2-like protein","22","-0.209224611969475","0.735104053521892","0.712094298995464"
   "P14923","Junction plakoglobin","22","0.934463545372491","-0.828806036526274","0.547048408575383"
   "P02788","Lactotransferrin","21","-0.45056216516701","-1.64535181290339","-0.121541921433356"
   "Q9HC84","Mucin-5B","21","0.393485706378678","1.17955800051648","-0.71069922504811"
   "P29508","Serpin B3","20","0.268965497630581","2.66370292320786","-0.379056180304168"
   "P63261","Actin, cytoplasmic 2","19","0.576409665701943","-0.365778562711543","-1.13924129062893"
   "Q8N1N4","Keratin, type II cytoskeletal 78","18","0.453594058873406","0.262858498280356","-0.066949785041258"
   "Q04695","Keratin, type I cytoskeletal 17","18","-0.390544013682014","0.799377812209948","0.32379562538293"
   "P01876","Ig alpha-1 chain C region","16","-1.23660856565626","-0.107281858303556","0.465342893909439"
   "Q01469","Fatty acid-binding protein 5, epidermal","15","0.987086596505533","-0.454576896498696","-0.908346004493488"
   "P31944","Caspase-14","15","-0.158238562638001","-1.22782239918318","-1.45961904941498"
   "P01833","Polymeric immunoglobulin receptor","15","1.79749543440842","2.24792797404845","0.0433115548086814"
   "P06733","Alpha-enolase","15","-0.529824448081063","-0.580373907648523","-0.128065917022257"
   "P25311","Zinc-alpha-2-glycoprotein","15","0.25270420276034","0.532452229745449","-0.583197689835694"
   "Q15149","Plectin","15","0.800992521250129","-0.239696040459912","0.570554821244026"
   "P19013","Keratin, type II cytoskeletal 4","13","1.70952190012008","0.308131652584916","0.0900971735188416"
   "Q6KB66","Keratin, type II cytoskeletal 80","13","0.928154727982437","-0.134171849056037","1.0281932486236"
   "Q08188","Protein-glutamine gamma-glutamyltransferase E","12","1.16356745871053","-0.874317674169176","0.440187650175449"
   "P13646","Keratin, type I cytoskeletal 13","11","0.282856655400208","-0.597587136883014","2.99648733768487"
   "Q86YZ3","Hornerin","11","-0.197833395930581","-0.162400177781364","1.20131785629863"
   "P04259","Keratin, type II cytoskeletal 6B","10","0.67996181861908","0.43733041003339","0.441631415415337"
   "P02545","Prelamin-A/C;Lamin-A/C","10","-0.547161258839918","-2.17826263345731","-0.218595085062566"
   "P04083","Annexin A1","10","0.337054059930408","-0.500299373648672","0.721453785306024"
   "P11021","78 kDa glucose-regulated protein","10","0.655828561019925","0.0591418554474826","0.0807075652098517"
   "P02787","Serotransferrin","9","-1.79791240973716","1.09646334451946","-1.15666237196621"
   "P04040","Catalase","9","-0.15346475266988","-1.17381140096271","0.487301993924019"
   "P31151","Protein S100-A7","9","1.6584112693271","-0.253857572420701","0.740996412523921"
   "P31947","14-3-3 protein sigma","9","0.409294936277862","-0.653017509957507","-0.740809901386044"
   "Q96P63","Serpin B12","9","-1.46628591247549","-1.56067400018267","0.855248477589862"
   "P14618","Pyruvate kinase PKM","9","-0.532753243163142","-0.882648291457647","-0.283723902689029"
   "P60174","Triosephosphate isomerase","9","-0.332143130316749","-0.647525088691405","-0.110917329848716"
   "Q06830","Peroxiredoxin-1","9","0.307558110800446","-0.949225629556292","-0.780593800625419"
   "P01040","Cystatin-A","8","-0.525374243612587","1.12688197366862","-0.595845059733201"
   "P05089","Arginase-1","8","0.527667526535661","1.72760613780923","0.0592892011454951"
   "P01834","Ig kappa chain C region","8","0.748193650431916","-0.297626773938842","0.62934935543165"
   "P04406","Glyceraldehyde-3-phosphate dehydrogenase","8","0.571325118638535","-0.244422721423289","0.121407037219411"
   "P0DMV9","Heat shock 70 kDa protein 1B","8","0.542462985882966","-0.849214297769283","-1.60686934699257"
   "P13639","Elongation factor 2","8","0.559971315637159","0.115102689862871","0.551634803660207"
   "P35579","Myosin-9","8","-1.73905343105432","0.707863098096751","1.25793163727429"
   "P68371","Tubulin beta-4B chain","8","-0.583549598471542","-0.92020629599324","0.62496286955718"

-----

.. class:: infomark

**Authors**

David Christiany, Florence Combes, Yves Vandenbrouck CEA, INSERM, CNRS, Grenoble-Alpes University, BIG Institute, FR

Sandra Dérozier, Olivier Rué, Christophe Caron, Valentin Loux INRA, Paris-Saclay University, MAIAGE Unit, Migale Bioinformatics platform

This work has been partially funded through the French National Agency for Research (ANR) IFB project.

Contact support@proteore.org for any questions or concerns about the Galaxy implementation of this tool.
    ]]></help>
    <citations>
        <citation type="doi">10.1093/nar/gkx372</citation>
        <citation type="bibtex">
@misc{renameTODO,
  author = {Weijun Luo},
  year = {2013},
  title = {pathview},
  url = {https://bioconductor.org/packages/release/bioc/html/pathview.html},
}</citation>
    </citations>
</tool>
